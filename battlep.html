<html>
  <head>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <style>
    @font-face {
      font-family: "Panton";
      src: url("./Fonts/Panton.otf") format("truetype");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      overflow-y: hidden;
      overflow-x: hidden;
    }
    body {
      background-image: url(./Assets/background.png);
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      font-family: Panton;
    }

    .logo {
      width: 20%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      left: 50%;
    }

    .line {
      width: 95%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: -1.3%;
      left: 50%;
    }

    .rect1 {
      width: 24%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: 3.5%;
      left: 85%;
    }

    .rect2 {
      width: 50%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: 20%;
      left: 22%;
      z-index: 1;
    }

    .tbox {
      width: 35%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: -43%;
      left: 29%;
    }

    #rectangles {
      position: relative;
    }

    .text1,
    .text2,
    .blockstxt,
    .blockspo,
    .blockspt,
    .healthtxt,
    .healthpo,
    .healthpt,
    .damageltxt,
    .damagelpo,
    .damagelpt,
    .targettxt,
    .targetpo,
    .targetpt {
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 10;
      color: white;
      font-size: 30px;
      white-space: nowrap;
    }

    .text1 {
      top: 46%;
      left: 34%;
    }
    .text2 {
      top: 46%;
      left: 59%;
      font-size: 30px;
    }
    .blockstxt {
      top: 55%;
      left: 47%;
    }
    .blockspo {
      top: 59%;
      left: 45%;
    }
    .blockspt {
      top: 59%;
      left: 49%;
    }
    .healthtxt {
      top: 68%;
      left: 47%;
    }
    .healthpo {
      top: 71%;
      left: 45%;
    }
    .healthpt {
      top: 71%;
      left: 49%;
    }
    .damageltxt {
      top: 77%;
      left: 47%;
    }
    .damagelpo {
      top: 80%;
      left: 45%;
    }
    .damagelpt {
      top: 80%;
      left: 49%;
    }
    .targettxt {
      top: 85%;
      left: 47%;
    }
    .targetpo {
      top: 88%;
      left: 45%;
    }
    .targetpt {
      top: 88%;
      left: 49%;
    }

    .cl1 {
      position: absolute;
      top: 39%;
      left: 27%;
      transform: translate(-50%, -50%);
      width: 12%;
      height: 4%;
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
    }

    .cl2 {
      position: absolute;
      top: 91%;
      left: 85%;
      transform: translate(-50%, -50%);
      width: 21%;
      height: 5%;
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
    }

    .blockbt {
      position: absolute;
      top: 39%;
      left: 67%;
      transform: translate(-50%, -50%);
      width: 8%;
      height: 5%;
      background-image: linear-gradient(90deg, #50dbcb, #ffef3d);
      color: black;
      font-size: 30px;
      font-weight: bolder;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-width: 3px;
      border-style: solid;
    }

    .discord,
    #discordUserInfo {
      position: absolute;
      top: 5%;
      left: 92%;
      transform: translate(-50%, -50%);
    }

    .discord {
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
      transition: 0.6s ease-in-out;
      cursor: pointer;
      opacity: 1;
      pointer-events: auto;
    }

    .discord:hover {
      filter: brightness(0.5);
      scale: calc(0.9);
    }

    #discordUserInfo {
      position: absolute;
      top: 5%;
      left: 92%;
      transform: translate(-50%, 0);
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      z-index: 100;
      font-size: 14px;
      max-width: 280px;
      cursor: default;
      user-select: none;
    }
    #discordUserInfo .user-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #discordUserInfo .user-row img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }
    #discordUserInfo .user-row .username {
      font-weight: bold;
      cursor: pointer;
    }
    #discordUserInfo .dropdown-content {
      margin-top: 8px;
      border-top: 1px solid #444;
      padding-top: 8px;
    }
    #discordUserInfo button {
      margin-top: 5px;
      padding: 4px 10px;
      border-radius: 8px;
      border: none;
      background: #ff5555;
      color: white;
      cursor: pointer;
    }
    #discordUserInfo button:hover {
      background: #cc4444;
    }

    /* NEW: dropdown style */
    #playerOneCards {
      position: absolute;
      top: 52%;
      left: 34%;
      transform: translate(-50%, -50%);
      z-index: 11;
      width: 18%;
    }
  </style>
  <body>
    <div id="logoline">
      <img src="./Assets/SERIES_1_LOGO.png" class="logo" />
      <img src="./Assets/ICONS/Line_120.png" class="line" />
    </div>
    <div id="rectangles">
      <img src="./Assets/ICONS/COMMAND_OVERRIDE.png" class="rect1" />
      <img src="./Assets/ICONS/Rectangle_149.png" class="rect2" />
      <div
        id="selectedCardContainer"
        style="
          position: absolute;
          top: 55%;
          left: 27%;
          transform: translate(-50%, -50%);
          z-index: 999;
          pointer-events: none;
        "></div>
      <img src="./Assets/ICONS/Rectangle_148.png" class="tbox" />
      <div>
        <h1 class="text1">PLAYER ONE</h1>
        <!-- NEW dropdown under PLAYER ONE -->
        <select id="playerOneCards"></select>
      </div>
      <h1 class="text2">PLAYER TWO</h1>
      <p class="blockstxt">BLOCKS</p>
      <p class="blockspo">0</p>
      <p class="blockspt">0</p>
      <p class="healthtxt">HEALTH</p>
      <p class="healthpo">100</p>
      <p class="healthpt">100</p>
      <p class="damageltxt">DAMAGE LEFT</p>
      <p class="damagelpo">0</p>
      <p class="damagelpt">0</p>
      <p class="targettxt">TARGET</p>
      <p class="targetpo">NONE</p>
      <p class="targetpt">NONE</p>
      <button class="blockbt">BLOCK</button>
      <div id="discordUserInfo" style="display: none">
        <div class="user-row">
          <img id="discordUserAvatar" src="" alt="User avatar" />
          <span id="discordUserName" class="username"></span>
        </div>
        <div class="dropdown-content">
          <button id="logoutBtn">Logout</button>
        </div>
      </div>
      <button id="discordBtn" class="discord">Login</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
    <script>
      // Utilities
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Save token to localStorage
      function saveToken(token) {
        localStorage.setItem("token", token);
      }

      // Validate token expiration
      function isTokenValid(token) {
        try {
          const decoded = jwt_decode(token);
          if (!decoded.exp) return false;
          const now = Date.now() / 1000;
          return decoded.exp > now;
        } catch (e) {
          return false;
        }
      }

      // Build Discord avatar URL fallback
      function getDiscordAvatarUrl(user) {
        if (user.avatar) {
          const isAnimated = user.avatar.startsWith("a_");
          const format = isAnimated ? "gif" : "png";
          return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.${format}?size=64`;
        } else {
          let discrim = user.discriminator;
          if (!discrim) discrim = "0000";
          const defaultAvatarNumber = parseInt(discrim) % 5;
          return `https://cdn.discordapp.com/embed/avatars/${defaultAvatarNumber}.png`;
        }
      }

      // Render user info on top right when logged in
      function renderLoggedIn(user) {
        const btn = document.getElementById("discordBtn");
        const userInfo = document.getElementById("discordUserInfo");
        const userNameSpan = document.getElementById("discordUserName");
        const userAvatar = document.getElementById("discordUserAvatar");

        btn.style.display = "none";

        userNameSpan.textContent = `${user.username}#${
          user.discriminator || "0000"
        }`;
        userAvatar.src = getDiscordAvatarUrl(user);

        userInfo.style.display = "block";

        document.getElementById("logoutBtn").onclick = () => {
          localStorage.removeItem("token");
          window.location.href = "menu.html";
        };
      }

      function renderLoggedOut() {
        const btn = document.getElementById("discordBtn");
        const userInfo = document.getElementById("discordUserInfo");
        userInfo.style.display = "none";
        btn.style.display = "block";
        btn.textContent = "Login";
        btn.onclick = () => {
          window.location.href = "menu.html";
        };
      }

      async function fetchUserCards(token) {
        try {
          const response = await fetch(
            `https://vocadecks.netlify.app/.netlify/functions/getUserCards?token=${encodeURIComponent(
              token
            )}`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch cards");
          }
          const data = await response.json();
          return data.cards || [];
        } catch (err) {
          console.error(err);
          alert("Error fetching cards: " + err.message);
          return [];
        }
      }

      function populateCardDropdown(cards) {
        const select = document.getElementById("playerOneCards");
        select.innerHTML = "";

        if (!cards.length) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No cards available";
          select.appendChild(option);
          return;
        }

        cards.forEach((card) => {
          const option = document.createElement("option");
          option.value = card.id;
          option.textContent = card.name;
          select.appendChild(option);
        });

        if (cards[0]) {
          displaySelectedCard(cards[0].id);
        }
      }

      async function displaySelectedCard(cardId) {
        const container = document.getElementById("selectedCardContainer");
        if (!cardId) {
          container.innerHTML = "";
          return;
        }
        try {
          const token = localStorage.getItem("token");
          if (!token) throw new Error("No token found");

          const res = await fetch(
            `https://vocadecks.netlify.app/.netlify/functions/getUserCards?token=${encodeURIComponent(
              token
            )}&cardId=${encodeURIComponent(cardId)}`
          );
          if (!res.ok) throw new Error("Failed to fetch card data");
          const card = await res.json();

          container.innerHTML = `<img src="${card.image}" alt="${card.name}" style="width: 300px; border-radius: 15px;" />`;
        } catch (err) {
          console.error(err);
          container.innerHTML = "";
        }
      }

      (function () {
        let urlToken = getQueryParam("token");
        if (urlToken) {
          if (urlToken.startsWith("Bearer ")) {
            urlToken = urlToken.slice(7);
          }
          saveToken(urlToken);
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
        }

        const token = localStorage.getItem("token");

        if (token && isTokenValid(token)) {
          const user = jwt_decode(token);
          renderLoggedIn(user);

          fetchUserCards(token).then((cards) => {
            populateCardDropdown(cards);

            const sel = document.getElementById("playerOneCards");
            sel.addEventListener("change", function () {
              displaySelectedCard(this.value);
            });
          });
        } else {
          alert("You must be logged in to access this page.");
          window.location.href = "menu.html";
        }
      })();
    </script>
  </body>
</html>
