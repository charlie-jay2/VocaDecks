<html>
  <head>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <style>
    @font-face {
      font-family: "Panton";
      src: url("./Fonts/Panton.otf") format("truetype");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      overflow-y: hidden;
      overflow-x: hidden;
    }
    body {
      background-image: url(./Assets/background.png);
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      font-family: Panton;
    }

    .logo {
      width: 20%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      left: 50%;
    }

    .line {
      width: 95%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: -1.3%;
      left: 50%;
    }

    .rect1 {
      width: 24%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: 3.5%;
      left: 85%;
    }

    .rect2 {
      width: 50%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: 20%;
      left: 22%;
      z-index: 1;
    }

    .tbox {
      width: 35%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: -43%;
      left: 29%;
    }

    #rectangles {
      position: relative;
    }

    .text1,
    .text2,
    .blockstxt,
    .blockspo,
    .blockspt,
    .healthtxt,
    .healthpo,
    .healthpt,
    .damageltxt,
    .damagelpo,
    .damagelpt,
    .targettxt,
    .targetpo,
    .targetpt {
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 10;
      color: white;
      font-size: 30px;
      white-space: nowrap;
    }

    .text1 {
      top: 46%;
      left: 34%;
    }
    .text2 {
      top: 46%;
      left: 59%;
      font-size: 30px;
    }
    .blockstxt {
      top: 55%;
      left: 47%;
    }
    .blockspo {
      top: 59%;
      left: 45%;
    }
    .blockspt {
      top: 59%;
      left: 49%;
    }
    .healthtxt {
      top: 68%;
      left: 47%;
    }
    .healthpo {
      top: 71%;
      left: 45%;
    }
    .healthpt {
      top: 71%;
      left: 49%;
    }
    .damageltxt {
      top: 77%;
      left: 47%;
    }
    .damagelpo {
      top: 80%;
      left: 45%;
    }
    .damagelpt {
      top: 80%;
      left: 49%;
    }
    .targettxt {
      top: 85%;
      left: 47%;
    }
    .targetpo {
      top: 88%;
      left: 45%;
    }
    .targetpt {
      top: 88%;
      left: 49%;
    }

    .cl1 {
      position: absolute;
      top: 39%;
      left: 27%;
      transform: translate(-50%, -50%);
      width: 12%;
      height: 4%;
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
    }

    .cl2 {
      position: absolute;
      top: 91%;
      left: 85%;
      transform: translate(-50%, -50%);
      width: 21%;
      height: 5%;
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
    }

    .blockbt {
      position: absolute;
      top: 39%;
      left: 67%;
      transform: translate(-50%, -50%);
      width: 8%;
      height: 5%;
      background-image: linear-gradient(90deg, #50dbcb, #ffef3d);
      color: black;
      font-size: 30px;
      font-weight: bolder;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-width: 3px;
      border-style: solid;
    }

    .discord,
    #discordUserInfo {
      position: absolute;
      top: 5%;
      left: 92%;
      transform: translate(-50%, -50%);
    }

    .discord {
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
      transition: 0.6s ease-in-out;
      cursor: pointer;
      opacity: 1;
      pointer-events: auto;
    }

    .discord:hover {
      filter: brightness(0.5);
      scale: calc(0.9);
    }

    #discordUserInfo {
      position: absolute;
      top: 5%;
      left: 92%;
      transform: translate(-50%, 0);
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      z-index: 100;
      font-size: 14px;
      max-width: 280px;
      cursor: default;
      user-select: none;
    }
    #discordUserInfo .user-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #discordUserInfo .user-row img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }
    #discordUserInfo .user-row .username {
      font-weight: bold;
      cursor: pointer;
    }
    #discordUserInfo .dropdown-content {
      margin-top: 8px;
      border-top: 1px solid #444;
      padding-top: 8px;
    }

    #playerOneCards {
      position: absolute;
      top: 52%;
      left: 34%;
      transform: translate(-50%, -50%);
      z-index: 11;
      width: 18%;
    }
  </style>
  <body>
    <div id="logoline">
      <img src="./Assets/SERIES_1_LOGO.png" class="logo" />
      <img src="./Assets/ICONS/Line_120.png" class="line" />
    </div>
    <div id="rectangles">
      <img src="./Assets/ICONS/COMMAND_OVERRIDE.png" class="rect1" />
      <img src="./Assets/ICONS/Rectangle_149.png" class="rect2" />
      <div
        id="selectedCardContainer"
        style="
          width: 15%;
          height: auto;
          position: absolute;
          left: 23.5%;
          bottom: 15px;
          z-index: 1;
        "></div>
      <img src="./Assets/ICONS/Rectangle_148.png" class="tbox" />
      <div>
        <h1 class="text1">PLAYER ONE</h1>
        <select id="playerOneCards" class="form-control">
          <option value="">-- Your Cards --</option>
        </select>
        <div
          id="playerTwoInfo"
          style="
            position: relative;
            left: 50%;
            bottom: 30%;
            color: white;
            text-align: center;
            z-index: 11;
          ">
          <h1
            id="playerTwoUsername"
            style="font-size: 30px; position: absolute; left: 1%; bottom: 440">
            PLAYER TWO
          </h1>
          <div
            id="playerTwoCardContainer"
            style="
              width: 40%;
              height: auto;
              position: absolute;
              left: 43%;
              bottom: 15px;
              z-index: 1;
            "></div>
        </div>
      </div>
      <h1 class="blockstxt">BLOCKS</h1>
      <h1 class="blockspo">0</h1>
      <h1 class="blockspt">0</h1>
      <h1 class="healthtxt">HEALTH</h1>
      <h1 class="healthpo">0</h1>
      <h1 class="healthpt">0</h1>
      <h1 class="damageltxt">DAMAGE L</h1>
      <h1 class="damagelpo">0</h1>
      <h1 class="damagelpt">0</h1>
      <h1 class="targettxt">TARGET S</h1>
      <h1 class="targetpo">0</h1>
      <h1 class="targetpt">0</h1>
      <div>
        <form>
          <input type="text" placeholder=" ATTACK... (LIMIT 50)" class="cl1" />
          <input type="text" placeholder=" COMMAND..." class="cl2" />
        </form>
      </div>
      <div>
        <button class="blockbt">BLOCK</button>
      </div>
    </div>

    <div id="buttons">
      <img
        src="./Assets/ICONS/back.png"
        class="back"
        style="margin-left: 15px; position: relative; bottom: 45px" />
      <img
        src="./Assets/ICONS/Settings.png"
        class="back"
        style="margin-left: 15px; position: relative; bottom: 45px" />
      <div id="discordUserInfo" style="display: none"></div>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <script>
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function saveToken(token) {
      if (typeof token === "string" && token.startsWith("Bearer ")) {
        token = token.slice(7);
      }
      localStorage.setItem("token", token);
      localStorage.setItem("tokenSavedAt", Date.now());

      if (window.history.replaceState) {
        const newUrl =
          window.location.protocol +
          "//" +
          window.location.host +
          window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
      }
    }

    function getToken() {
      return localStorage.getItem("token");
    }

    function decodeToken(token) {
      try {
        return jwt_decode(token);
      } catch {
        return null;
      }
    }

    // function redirectToIndex() {
    //   window.location.href = "index.html";
    // }

    async function fetchUserCards(token) {
      try {
        const response = await fetch(
          `/.netlify/functions/getUserCards?token=${encodeURIComponent(token)}`
        );
        if (!response.ok) throw new Error("Failed to fetch user cards");
        const data = await response.json();
        console.log("Fetched cards:", data.cards);
        return data.cards || [];
      } catch (error) {
        console.error(error);
        throw error;
      }
    }

    function showDiscordUserInfo(user) {
      const container = document.getElementById("discordUserInfo");
      if (!container) return;

      container.style.display = "block";
      container.innerHTML = `
      <div class="user-row">
        <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=64" alt="avatar" />
        <span class="username" title="${user.username}">${user.username}</span>
      </div>
    `;
    }

    function displayCardImage(cardName, containerId = "selectedCardContainer") {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (!cardName) {
        container.innerHTML = "";
        return;
      }

      const encodedFileName = encodeURIComponent(cardName);
      const imgSrc = `./Cards/${encodedFileName}`;
      console.log(`📸 Displaying in #${containerId}:`, imgSrc);

      container.innerHTML = `<img src="${imgSrc}" alt="Selected Card" style="
      width: 90%;
      height: auto;
      position: absolute;
      left: 20%;
      ${
        containerId === "playerTwoCardContainer"
          ? "left: 43%; bottom: 15;"
          : "left: 26.5%; bottom: 15;"
      }
      z-index: 1;
    " />`;
    }

    function formatCardNameWithRarity(name) {
      let cleanName = name;

      if (!cleanName.toLowerCase().endsWith(".png")) {
        cleanName += ".png";
      }

      const rarityMatch = cleanName.match(/^r([1-5])/i);
      if (!rarityMatch) return cleanName;

      const rarityNum = rarityMatch[1];
      const rarityMap = {
        1: "COMMON",
        2: "EXTRA",
        3: "RARE",
        4: "LEGENDARY",
        5: "UNTOUCHED",
      };

      const baseName = cleanName.replace(/^r[1-5]/i, "").replace(/\.png$/i, "");
      return `${baseName.trim()} (${rarityMap[rarityNum] || "UNKNOWN"})`;
    }

    async function init() {
      let token = getToken();

      if (!token) {
        const urlToken = getQueryParam("token");
        if (urlToken) {
          saveToken(urlToken);
          token = urlToken;
        } else {
          // redirectToIndex();
          console.log("No token found, redirect or handle accordingly");
          return;
        }
      }

      const decoded = decodeToken(token);
      if (!decoded || !decoded.username || !decoded.id || !decoded.avatar) {
        localStorage.removeItem("token");
        localStorage.removeItem("tokenSavedAt");
        // redirectToIndex();
        console.log("Invalid token, redirect or handle accordingly");
        return;
      }

      showDiscordUserInfo(decoded);

      const playerOneHeading = document.querySelector(".text1");
      if (playerOneHeading) {
        playerOneHeading.textContent = decoded.username.toUpperCase();
      }

      const matchedOpponent =
        localStorage.getItem("matchedOpponent") || "PLAYER TWO";
      const playerTwoHeading = document.getElementById("playerTwoUsername");
      if (playerTwoHeading) {
        playerTwoHeading.textContent = matchedOpponent.toUpperCase();
      }

      const cards = await fetchUserCards(token);
      const dropdown = document.getElementById("playerOneCards");

      if (dropdown) {
        dropdown.innerHTML = `<option value="">-- Your Cards --</option>`;

        cards.forEach((card) => {
          let val = (card.name || card.id || card).trim();
          if (!val.toLowerCase().endsWith(".png")) {
            val += ".png";
          }

          const option = document.createElement("option");
          option.value = val;

          const lowerVal = val.toLowerCase();
          if (
            lowerVal === "cherry mikudayo.png" ||
            lowerVal === "mikudayo.png"
          ) {
            option.textContent = val.replace(/\.png$/i, "");
          } else {
            option.textContent = formatCardNameWithRarity(val);
          }

          dropdown.appendChild(option);
        });

        dropdown.addEventListener("change", (e) => {
          displayCardImage(e.target.value, "selectedCardContainer");
          sendCardSelection(e.target.value);
        });
      }

      setupWebSocket(token, decoded.username);
    }

    let socket;
    let currentUsername;

    function setupWebSocket(token, username) {
      currentUsername = username;

      const wsUrl = "wss://vdbe-0f2p.onrender.com"; // your WebSocket URL
      socket = new WebSocket(`${wsUrl}?token=${encodeURIComponent(token)}`);

      socket.addEventListener("open", () => {
        console.log("🔗 WebSocket connected");
      });

      socket.addEventListener("message", (event) => {
        let msg;
        try {
          msg = JSON.parse(event.data);
        } catch {
          console.warn("⚠️ Non-JSON WS message:", event.data);
          return;
        }

        if (msg.type === "welcome") {
          console.log(msg.message);
        } else if (msg.type === "status") {
          console.log("Status:", msg.message);
        } else if (msg.type === "opponentSelection") {
          console.log(
            `🎴 Opponent (${msg.username}) selected: ${msg.cardName}`
          );

          if (msg.username !== currentUsername) {
            // Opponent’s card, show for Player TWO
            displayCardImage(msg.cardName, "playerTwoCardContainer");
          }
        } else if (msg.type === "matched") {
          console.log(`✅ Connected to ${msg.opponent}`);
          console.log(`🧑‍💻 You are: ${msg.yourName} (${msg.role})`);

          localStorage.setItem("matchedOpponent", msg.opponent);
          localStorage.setItem("yourName", msg.yourName);
          localStorage.setItem("yourRole", msg.role);

          const p2Name = document.getElementById("playerTwoUsername");
          if (p2Name) p2Name.textContent = msg.opponent.toUpperCase();
        }
      });

      socket.addEventListener("close", () => {
        console.log("❌ WebSocket disconnected");
      });

      socket.addEventListener("error", (error) => {
        console.error("🚨 WebSocket error:", error);
      });
    }

    function sendCardSelection(cardName) {
      if (socket && socket.readyState === WebSocket.OPEN && cardName) {
        const payload = {
          type: "selection",
          cardName: cardName,
        };
        console.log("📤 Sending card selection:", payload);
        socket.send(JSON.stringify(payload));
      }
    }

    init();
  </script>
</html>
