<html>
  <head>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <style>
    @font-face {
      font-family: "Panton";
      src: url("./Fonts/Panton.otf") format("truetype");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    html,
    body {
      height: 100%;
      overflow: hidden; /* Prevent scrolling */
      margin: 0;
      padding: 0;
    }

    body {
      background-image: url(./Assets/background.png);
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      font-family: Panton;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    .logo {
      width: 20%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      left: 50%;
    }

    .line {
      width: 95%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: -1.3%;
      left: 50%;
    }

    .rect1 {
      width: 24%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: 3.5%;
      left: 85%;
    }

    .rect2 {
      width: 50%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: 20%;
      left: 22%;
      z-index: 1;
    }

    .tbox {
      width: 35%;
      height: auto;
      position: relative;
      transform: translateX(-50%);
      margin-top: -43%;
      left: 29%;
    }

    #rectangles {
      position: relative;
    }

    .text1,
    .text2,
    .blockstxt,
    .blockspo,
    .blockspt,
    .healthtxt,
    .healthpo,
    .healthpt,
    .damageltxt,
    .damagelpo,
    .damagelpt {
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 10;
      color: white;
      font-size: 30px;
      white-space: nowrap;
    }

    .text1 {
      top: 46%;
      left: 34%;
    }
    .text2 {
      top: 46%;
      left: 59%;
      font-size: 30px;
    }
    .blockstxt {
      top: 55%;
      left: 47%;
    }
    .blockspo {
      top: 59%;
      left: 45%;
    }
    .blockspt {
      top: 59%;
      left: 49%;
    }
    .healthtxt {
      top: 68%;
      left: 47%;
    }
    .healthpo {
      top: 71%;
      left: 45%;
    }
    .healthpt {
      top: 71%;
      left: 49%;
    }
    .damageltxt {
      top: 77%;
      left: 47%;
    }
    .damagelpo {
      top: 80%;
      left: 45%;
    }
    .damagelpt {
      top: 80%;
      left: 49%;
    }

    .cl1 {
      position: absolute;
      top: 39%;
      left: 27%;
      transform: translate(-50%, -50%);
      width: 12%;
      height: 4%;
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
    }

    .cl2 {
      position: absolute;
      top: 91%;
      left: 85%;
      transform: translate(-50%, -50%);
      width: 21%;
      height: 5%;
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
    }

    .blockbt {
      position: absolute;
      top: 39%;
      left: 67%;
      transform: translate(-50%, -50%);
      width: 8%;
      height: 5%;
      background-image: linear-gradient(90deg, #50dbcb, #ffef3d);
      color: black;
      font-size: 30px;
      font-weight: bolder;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-width: 3px;
      border-style: solid;
    }

    .discord,
    #discordUserInfo {
      position: absolute;
      top: 5%;
      left: 92%;
      transform: translate(-50%, -50%);
    }

    .discord {
      background-color: black;
      color: gray;
      font-family: Panton;
      border-radius: 15px;
      border-color: white;
      border-style: solid;
      transition: 0.6s ease-in-out;
      cursor: pointer;
      opacity: 1;
      pointer-events: auto;
    }

    .discord:hover {
      filter: brightness(0.5);
      scale: calc(0.9);
    }

    #discordUserInfo {
      position: absolute;
      top: 5%;
      left: 92%;
      transform: translate(-50%, 0);
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      z-index: 100;
      font-size: 14px;
      max-width: 280px;
      cursor: default;
      user-select: none;
    }
    #discordUserInfo .user-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #discordUserInfo .user-row img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }
    #discordUserInfo .user-row .username {
      font-weight: bold;
      cursor: pointer;
    }
    #discordUserInfo .dropdown-content {
      margin-top: 8px;
      border-top: 1px solid #444;
      padding-top: 8px;
    }

    #playerOneCards {
      position: absolute;
      top: 52%;
      left: 34%;
      transform: translate(-50%, -50%);
      z-index: 11;
      width: 18%;
    }
  </style>
  <body>
    <div id="logoline">
      <img src="./Assets/SERIES_1_LOGO.png" class="logo" />
      <img src="./Assets/ICONS/Line_120.png" class="line" />
    </div>
    <div id="rectangles">
      <img src="./Assets/ICONS/COMMAND_OVERRIDE.png" class="rect1" />
      <img src="./Assets/ICONS/Rectangle_149.png" class="rect2" />
      <div
        id="selectedCardContainer"
        style="
          width: 15%;
          height: auto;
          position: absolute;
          left: 23%;
          bottom: 15px;
          z-index: 1;
        "></div>
      <img src="./Assets/ICONS/Rectangle_148.png" class="tbox" />
      <div>
        <h1 class="text1">PLAYER ONE</h1>
        <select id="playerOneCards" class="form-control">
          <option value="">-- Your Cards --</option>
        </select>
        <div
          id="playerTwoInfo"
          style="
            position: relative;
            left: 50%;
            bottom: 30%;
            color: white;
            text-align: center;
            z-index: 11;
          ">
          <h1
            id="playerTwoUsername"
            style="font-size: 30px; position: absolute; left: 1%; bottom: 440">
            PLAYER TWO
          </h1>
          <div
            id="playerTwoCardContainer"
            style="
              width: 15%;
              height: auto;
              position: absolute;
              left: -3%;
              bottom: 15px;
              z-index: 1;
            "></div>
        </div>
      </div>
      <h1 class="blockstxt">BLOCKS</h1>
      <h1 class="blockspo">0</h1>
      <h1 class="blockspt">0</h1>
      <h1 class="healthtxt">HEALTH</h1>
      <h1 class="healthpo">0</h1>
      <h1 class="healthpt">0</h1>
      <h1 class="damageltxt">DAMAGE L</h1>
      <h1 class="damagelpo">0</h1>
      <h1 class="damagelpt">0</h1>
      <div>
        <form>
          <input type="text" placeholder=" ATTACK... (LIMIT 50)" class="cl1" />
          <input type="text" placeholder=" COMMAND..." class="cl2" />
        </form>
      </div>
      <div>
        <button class="blockbt">BLOCK</button>
      </div>
    </div>

    <div id="buttons">
      <a href="./menu.html"
        ><img
          src="./Assets/ICONS/back.png"
          class="back"
          style="margin-left: 15px; position: relative; bottom: 45px"
      /></a>
      <img
        src="./Assets/ICONS/Settings.png"
        class="back"
        style="margin-left: 15px; position: relative; bottom: 45px" />
      <div id="discordUserInfo" style="display: none"></div>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Card Data (embedded) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const cardsData = {
      common: [
        {
          name: "r1Rin C.png",
          stats: { Health: 20, "Damage Limit": 20, "Vocal Range": 15 },
        },
        {
          name: "r1Len C.png",
          stats: { Health: 20, "Damage Limit": 20, "Vocal Range": 20 },
        },
        {
          name: "r1MEIKO C.png",
          stats: { Health: 14, "Damage Limit": 14, "Vocal Range": 20 },
        },
        {
          name: "r1KAITO C.png",
          stats: { Health: 10, "Damage Limit": 10, "Vocal Range": 20 },
        },
        {
          name: "r1Luka C.png",
          stats: { Health: 18, "Damage Limit": 18, "Vocal Range": 20 },
        },
        {
          name: "r1Yowane Haku C.png",
          stats: { Health: 18, "Damage Limit": 18, "Vocal Range": 20 },
        },
      ],
      extra: [
        {
          name: "r2Hatsune Miku E.png",
          stats: { Health: 25, "Damage Limit": 25, "Vocal Range": 25 },
        },
        {
          name: "r2Gumi E.png",
          stats: { Health: 30, "Damage Limit": 30, "Vocal Range": 25 },
        },
        {
          name: "r2Rin E.png",
          stats: { Health: 34, "Damage Limit": 34, "Vocal Range": 15 },
        },
        {
          name: "r2Flower E.png",
          stats: { Health: 35, "Damage Limit": 35, "Vocal Range": 30 },
        },
        {
          name: "r2Tohoko E.png",
          stats: { Health: 30, "Damage Limit": 30, "Vocal Range": 40 },
        },
        {
          name: "r2MEIKO E.png",
          stats: { Health: 24, "Damage Limit": 24, "Vocal Range": 20 },
        },
        {
          name: "r2Len E.png",
          stats: { Health: 35, "Damage Limit": 35, "Vocal Range": 20 },
        },
        {
          name: "r2Luka E.png",
          stats: { Health: 27, "Damage Limit": 27, "Vocal Range": 20 },
        },
        {
          name: "r2KAITO E.png",
          stats: { Health: 30, "Damage Limit": 30, "Vocal Range": 20 },
        },
        {
          name: "r2Anon & Kanon E.png",
          stats: { Health: 28, "Damage Limit": 28, "Vocal Range": 20 },
        },
      ],
      rare: [
        {
          name: "r3Hatsune Miku R.png",
          stats: { Health: 40, "Damage Limit": 40, "Vocal Range": 25 },
        },
        {
          name: "r3Gumi R.png",
          stats: { Health: 45, "Damage Limit": 45, "Vocal Range": 25 },
        },
        {
          name: "r3Rana R.png",
          stats: { Health: 40, "Damage Limit": 40, "Vocal Range": 25 },
        },
        {
          name: "r3Tohoko R.png",
          stats: { Health: 42, "Damage Limit": 42, "Vocal Range": 40 },
        },
        {
          name: "r3Macne Nana R.png",
          stats: { Health: 48, "Damage Limit": 48, "Vocal Range": 10 },
        },
        {
          name: "r3Luka R.png",
          stats: { Health: 48, "Damage Limit": 48, "Vocal Range": 20 },
        },
        {
          name: "r3Teto R.png",
          stats: { Health: 45, "Damage Limit": 45, "Vocal Range": 35 },
        },
        {
          name: "r3Anon & Kanon R.png",
          stats: { Health: 38, "Damage Limit": 38, "Vocal Range": 20 },
        },
        {
          name: "r3Akoi Lapis R.png",
          stats: { Health: 48, "Damage Limit": 48, "Vocal Range": 20 },
        },
        {
          name: "r3Mikudayo.png",
          stats: { Health: 40, "Damage Limit": 40, "Vocal Range": 30 },
        },
        {
          name: "r3Cherry Mikudayo.png",
          stats: { Health: 50, "Damage Limit": 50, "Vocal Range": 30 },
        },
        {
          name: "r5Defoko.png",
          stats: { Health: 45, "Damage Limit": 45, "Vocal Range": 20 },
        },
      ],
      legendary: [
        {
          name: "r4Gumi L.png",
          stats: { Health: 64, "Damage Limit": 64, "Vocal Range": 25 },
        },
        {
          name: "r4Rana L.png",
          stats: { Health: 75, "Damage Limit": 75, "Vocal Range": 25 },
        },
        {
          name: "r4Galaco L.png",
          stats: { Health: 80, "Damage Limit": 80, "Vocal Range": 30 },
        },
        {
          name: "r4Macne Nana L.png",
          stats: { Health: 78, "Damage Limit": 78, "Vocal Range": 10 },
        },
        {
          name: "r4Akita Neru L.png",
          stats: { Health: 65, "Damage Limit": 65, "Vocal Range": 30 },
        },
        {
          name: "r4KAAI YUKI L.png",
          stats: { Health: 80, "Damage Limit": 80, "Vocal Range": 20 },
        },
        {
          name: "r4Teto L.png",
          stats: { Health: 78, "Damage Limit": 78, "Vocal Range": 35 },
        },
        {
          name: "r4Kokone L.png",
          stats: { Health: 80, "Damage Limit": 80, "Vocal Range": 45 },
        },
        {
          name: "r5Defoko L.png",
          stats: { Health: 70, "Damage Limit": 70, "Vocal Range": 20 },
        },
        {
          name: "r5Momone L.png",
          stats: { Health: 72, "Damage Limit": 72, "Vocal Range": 15 },
        },
      ],
      untouched: [
        {
          name: "r5Rana U.png",
          stats: { Health: 87, "Damage Limit": 87, "Vocal Range": 20 },
        },
        {
          name: "r5Galaco U.png",
          stats: { Health: 97, "Damage Limit": 97, "Vocal Range": 30 },
        },
        {
          name: "r5Teto U.png",
          stats: { Health: 95, "Damage Limit": 95, "Vocal Range": 35 },
        },
        {
          name: "r5CaseO U.png",
          stats: { Health: 98, "Damage Limit": 98, "Vocal Range": 20 },
        },
        {
          name: "r5Kokone U.png",
          stats: { Health: 100, "Damage Limit": 100, "Vocal Range": 45 },
        },
        {
          name: "r5Momone U.png",
          stats: { Health: 94, "Damage Limit": 94, "Vocal Range": 15 },
        },
      ],
    };

    function getRarityGroup(prefix) {
      switch (prefix) {
        case "r1":
          return "common";
        case "r2":
          return "extra";
        case "r3":
          return "rare";
        case "r4":
          return "legendary";
        case "r5":
          return "untouched";
        default:
          return null;
      }
    }

    function findCard(cardName) {
      const name = (cardName || "").trim();
      const prefix = name.slice(0, 2);
      const group = getRarityGroup(prefix);
      return group && cardsData[group]
        ? cardsData[group].find((c) => c.name === name) || null
        : null;
    }

    function updatePlayer1Stats(stats) {
      document.querySelector(".healthpo").textContent = stats?.Health ?? "-";
      document.querySelector(".damagelpo").textContent =
        stats?.["Damage Limit"] ?? "-";
    }
    function updatePlayer2Stats(stats) {
      document.querySelector(".healthpt").textContent = stats?.Health ?? "-";
      document.querySelector(".damagelpt").textContent =
        stats?.["Damage Limit"] ?? "-";
    }

    async function setPlayersCards(p1Name, p2Name) {
      const c1 = p1Name ? findCard(p1Name) : null;
      const c2 = p2Name ? findCard(p2Name) : null;
      updatePlayer1Stats(c1?.stats);
      updatePlayer2Stats(c2?.stats);
    }

    function displayCardImage(cardName, containerId = "selectedCardContainer") {
      const el = document.getElementById(containerId);
      if (!el) return;
      if (!cardName) {
        el.innerHTML = "";
        return;
      }
      const src = `./Cards/${encodeURIComponent(cardName)}`;
      el.innerHTML = `<img src="${src}" style="
    width:90%; height:auto; position:absolute;
    ${
      containerId === "playerTwoCardContainer"
        ? "left:43%;bottom:15;"
        : "left:26.5%;bottom:15;"
    }
    z-index:1;" />`;
    }

    function getQueryParam(param) {
      return new URLSearchParams(window.location.search).get(param);
    }
    function saveToken(t) {
      let token =
        typeof t === "string" && t.startsWith("Bearer ") ? t.slice(7) : t;
      localStorage.setItem("token", token);
      localStorage.setItem("tokenSavedAt", Date.now());
      history.replaceState({}, document.title, location.pathname);
    }
    function getToken() {
      return localStorage.getItem("token");
    }
    function decodeToken(token) {
      try {
        return jwt_decode(token);
      } catch {
        return null;
      }
    }

    async function fetchUserCards(token) {
      const resp = await fetch(
        `/.netlify/functions/getUserCards?token=${encodeURIComponent(token)}`
      );
      if (!resp.ok) throw new Error("Failed to fetch user cards");
      const data = await resp.json();
      return data.cards || [];
    }

    function showDiscordUserInfo(user) {
      const c = document.getElementById("discordUserInfo");
      if (!c) return;
      c.style.display = "block";
      c.innerHTML = `
    <div class="user-row">
      <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=64" alt="avatar"/>
      <span class="username" title="${user.username}">${user.username}</span>
    </div>`;
    }

    function sendCardSelection(name) {
      if (socket && socket.readyState === WebSocket.OPEN && name) {
        socket.send(JSON.stringify({ type: "selection", cardName: name }));
      }
    }

    let socket,
      currentUsername = "";

    function setupWebSocket(token, username) {
      currentUsername = username;
      socket = new WebSocket(
        `wss://vdbe-0f2p.onrender.com?token=${encodeURIComponent(token)}`
      );
      socket.addEventListener("open", () => console.log("ðŸ”— WS connected"));
      socket.addEventListener("message", async (ev) => {
        let msg;
        try {
          msg = JSON.parse(ev.data);
        } catch {
          return;
        }
        if (msg.type === "user-info") {
          // Display player two's name
          const nameElement = document.getElementById("playerTwoName");
          if (nameElement) {
            nameElement.textContent = msg.username || "-";
          }
          await setPlayersCards(null, null); // Reset cards? Optional
        } else if (msg.type === "selection") {
          // Update Player Two card and stats
          const cardName = msg.cardName || "";
          displayCardImage(cardName, "playerTwoCardContainer");
          const cardData = findCard(cardName);
          updatePlayer2Stats(cardData?.stats);
        }
      });
      socket.addEventListener("close", () => console.log("âŒ WS disconnected"));
      socket.addEventListener("error", (e) =>
        console.error("WS error:", e.message)
      );
    }

    async function initialize() {
      let token = getQueryParam("token") || getToken();
      if (!token) {
        // Not logged in or no token, show login prompt
        document.getElementById("login").style.display = "block";
        return;
      }
      saveToken(token);
      const decoded = decodeToken(token);
      if (!decoded) {
        alert("Invalid token");
        return;
      }
      currentUsername = decoded.username || "";
      document.getElementById("playerOneName").textContent = currentUsername;
      showDiscordUserInfo(decoded);

      // Fetch user cards for dropdown
      try {
        const cards = await fetchUserCards(token);
        const select = document.getElementById("cardSelect");
        select.innerHTML = "";
        cards.forEach(({ name }) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
        select.disabled = false;

        // Update Player One card on selection change
        select.addEventListener("change", (e) => {
          const val = e.target.value;
          displayCardImage(val, "selectedCardContainer");
          const card = findCard(val);
          updatePlayer1Stats(card?.stats);
          sendCardSelection(val);
        });

        // Select first card by default if available
        if (cards.length > 0) {
          select.value = cards[0].name;
          displayCardImage(cards[0].name, "selectedCardContainer");
          const card = findCard(cards[0].name);
          updatePlayer1Stats(card?.stats);
          sendCardSelection(cards[0].name);
        }
      } catch (e) {
        console.error("Failed to load user cards:", e);
      }

      setupWebSocket(token, currentUsername);
    }

    window.onload = initialize;
  </script>
</html>
