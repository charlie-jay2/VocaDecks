<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <style>
      @font-face {
        font-family: "Panton";
        src: url("./Fonts/Panton.otf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      html,
      body {
        height: 100%;
        overflow: hidden;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        font-family: Panton, sans-serif;
        color: white;
        background-color: black;
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        background-image: var(--theme-bg);
        transition: background-image 0.8s ease;
      }

      .pfp {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 200px;
        height: 200px;
        background-color: white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        overflow: hidden;
        cursor: pointer;
      }

      .pfp img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .chaos,
      .settings,
      .shop,
      .solos {
        position: fixed;
        width: 150px;
        height: 150px;
        cursor: pointer;
        transition: transform 0.3s ease;
        user-select: none;
      }

      .chaos:hover,
      .settings:hover,
      .shop:hover,
      .solos:hover {
        transform: scale(1.15);
        z-index: 1000;
      }
    </style>
  </head>

  <body>
    <div class="pfp" onclick="window.location.href='./profile.html';"></div>

    <!-- Floating Circles -->
    <img src="./lobby/CHAOS.png" class="chaos" alt="Chaos" />
    <img src="./lobby/SETTINGS.png" class="settings" alt="Settings" />
    <img src="./lobby/SHOP.png" class="shop" alt="Shop" />
    <img src="./lobby/SOLOS.png" class="solos" alt="Solos" />

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

    <script>
      const themes = {
        t1: "./Menu/bg.png",
        t2: "./Profile/MIDNIGHT_BLUE.png",
        t3: "./Profile/TUNDRA_MANGO.png",
        t4: "./Profile/RADIANT_ROCKET_LOLLY.png",
        t5: "./Profile/CHERRIES__CREAM.png",
        t6: "./Profile/SIREN_PURPLE.png",
      };

      function applyStoredTheme() {
        const key = localStorage.getItem("selectedTheme") || "t1";
        const bgUrl = themes[key] || themes["t1"];
        document.body.style.setProperty("--theme-bg", `url(${bgUrl})`);
      }

      function isTokenValid(token) {
        try {
          const decoded = jwt_decode(token);
          return decoded.exp * 1000 > Date.now();
        } catch {
          return false;
        }
      }

      function renderLoggedOut() {
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }

      async function loadDiscordPfp() {
        const token = localStorage.getItem("token");
        if (!token || !isTokenValid(token)) {
          renderLoggedOut();
          return;
        }

        try {
          const res = await fetch("https://discord.com/api/v10/users/@me", {
            headers: {
              Authorization: token,
            },
          });

          if (!res.ok) throw new Error("Invalid token or rate-limited");

          const user = await res.json();
          const avatarUrl = user.avatar
            ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=128`
            : `https://cdn.discordapp.com/embed/avatars/0.png`;

          const pfpDiv = document.querySelector(".pfp");
          pfpDiv.innerHTML = `<img src="${avatarUrl}" alt="Avatar" />`;
        } catch (err) {
          console.error("Failed to fetch Discord avatar:", err);
        }
      }

      function setTheme(key) {
        const now = Date.now();
        if (now - lastChange < 1000) return;
        lastChange = now;

        document.body.style.background = `url(${themes[key].bg}) center/cover fixed no-repeat`;

        const [start, end] = themes[key].gradient || [];
        if (start && end) {
          document.querySelector(
            ".pb-fill"
          ).style.background = `linear-gradient(90deg, ${start} 0%, ${end} 100%)`;
        }

        document
          .querySelectorAll(".t1, .t2, .t3, .t4, .t5, .t6")
          .forEach((el) => el.classList.remove("active-theme"));
        document.querySelector("." + key)?.classList.add("active-theme");

        localStorage.setItem("selectedTheme", key);
      }

      const floatingCircles = [];

      class FloatingCircle {
        constructor(el, startX, startY) {
          this.el = el;
          this.width = 150;
          this.height = 150;

          this.windowWidth = window.innerWidth;
          this.windowHeight = window.innerHeight;

          this.x = startX;
          this.y = startY;
          this.vx = (Math.random() - 0.5) * 3;
          this.vy = (Math.random() - 0.5) * 3;

          this.updatePosition();
        }

        updatePosition() {
          this.el.style.left = this.x + "px";
          this.el.style.top = this.y + "px";
        }

        step() {
          this.x += this.vx;
          this.y += this.vy;

          if (this.x <= 0 || this.x >= this.windowWidth - this.width)
            this.vx *= -1;
          if (this.y <= 0 || this.y >= this.windowHeight - this.height)
            this.vy *= -1;

          this.updatePosition();
        }

        updateWindowSize(width, height) {
          this.windowWidth = width;
          this.windowHeight = height;
        }
      }

      function initFloatingCircles() {
        const selectors = [".chaos", ".settings", ".shop", ".solos"];
        const pfp = document.querySelector(".pfp");
        if (!pfp) return;

        const rect = pfp.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2 - 75;
        const centerY = rect.top + rect.height / 2 - 75;
        const radius = 10;

        selectors.forEach((selector, i) => {
          const el = document.querySelector(selector);
          if (el) {
            const baseAngle = (i * (2 * Math.PI)) / selectors.length;
            const angleOffset = (Math.random() - 0.5) * (Math.PI / 9);
            const angle = baseAngle + angleOffset;

            const startX = centerX + radius * Math.cos(angle);
            const startY = centerY + radius * Math.sin(angle);

            floatingCircles.push(new FloatingCircle(el, startX, startY));
          }
        });
      }

      function animate() {
        floatingCircles.forEach((circle) => circle.step());
        requestAnimationFrame(animate);
      }

      window.addEventListener("DOMContentLoaded", () => {
        applyStoredTheme();
        initFloatingCircles();
        animate();
        loadDiscordPfp();

        const solos = document.querySelector(".solos");
        if (solos) {
          solos.style.cursor = "pointer";
          solos.addEventListener("click", () => {
            window.location.href = "matchmaking.html";
          });
        }
      });

      window.addEventListener("resize", () => {
        floatingCircles.forEach((circle) =>
          circle.updateWindowSize(window.innerWidth, window.innerHeight)
        );
      });

      let lastChange = 0;
    </script>
  </body>
</html>
