<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Card Battle System</title>
    <style>
      @font-face {
        font-family: "Panton";
        src: url("Fonts/Panton.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      body {
        font-family: sans-serif;
        background: #222222;
        color: #f0f0f0;
        padding: 1rem;
        font-family: "Panton";
      }

      #log {
        border: 1px solid #555;
        background: #111;
        padding: 1rem;
        height: 200px;
        overflow-y: auto;
        margin-bottom: 1rem;
      }

      #controls {
        margin-bottom: 1rem;
      }

      select,
      input[type="text"] {
        padding: 0.5rem;
        margin: 0.25rem;
        background: #000;
        border: 1px solid #555;
        color: #f0f0f0;
      }

      button {
        padding: 0.5rem;
        margin: 0.25rem;
        background: linear-gradient(to right, #50dbcb, #ffef3d);
        background-size: 200% auto;
        border: 2px solid white;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        transition: background-position 1s ease;
      }

      button:hover {
        background-position: right center;
      }

      .stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .player {
        background: #222;
        padding: 0.5rem;
        border: 1px solid #555;
        flex: 1;
      }

      .player h3 {
        margin: 0 0 0.5rem;
      }

      .highlight {
        color: #6f9;
      }

      .logo {
        width: 35%;
        height: auto;
        position: relative;
        left: 50%;
        transform: translateX(-50%);
      }

      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background-color: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #FF6D6D, #FF8746);
        border-radius: 10px;
        transition: 0.6s ease-in-out;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #FF6D6D, #FF8746);
        transition: 0.6s ease-in-out;
      }
    </style>
  </head>
  <body>
    <img src="./Assets/SERIES_1_LOGO.png" class="logo" />
    <div id="log"></div>

    <div id="controls">
      <input
        type="text"
        id="usernameInput"
        placeholder="Enter two usernames, e.g. Alice Bob"
      />
      <div id="cardSelectContainer" style="display: none">
        <select id="cardSelect"></select>
        <button id="confirmCardBtn">Confirm Card</button>
      </div>
      <button id="startBtn">Next</button>
      <div id="commandContainer" style="display: none">
        <input
          type="text"
          id="commandInput"
          placeholder="Enter command (attack 10, block, wild <name>)"
        />
      </div>
    </div>

    <div class="stats">
      <div class="player">
        <h3 id="player1-name">Player 1</h3>
        <p>Health: <span id="p1-health"></span></p>
        <p>Damage Limit: <span id="p1-damageLimit"></span></p>
        <p>Shield: <span id="p1-shield"></span></p>
        <p>Block: <span id="p1-block"></span></p>
        <p>Wild: <span id="p1-wild"></span></p>
      </div>
      <div class="player">
        <h3 id="player2-name">Player 2</h3>
        <p>Health: <span id="p2-health"></span></p>
        <p>Damage Limit: <span id="p2-damageLimit"></span></p>
        <p>Shield: <span id="p2-shield"></span></p>
        <p>Block: <span id="p2-block"></span></p>
        <p>Wild: <span id="p2-wild"></span></p>
      </div>
    </div>

    <script>
      const wildCards = {
        attack: ["Sideshot", "Vocal Buster"],
        defense: ["Double Block", "Shield Field"],
        health: ["+10 Health", "+30 Health", "+50 Health", "+55 Health"],
      };

      const players = { P1: {}, P2: {} };
      let stage = "usernames";
      let currentPicker = "P1";
      let turn = "";

      const usernameInput = document.getElementById("usernameInput");
      const startBtn = document.getElementById("startBtn");
      const cardSelectContainer = document.getElementById(
        "cardSelectContainer"
      );
      const cardSelect = document.getElementById("cardSelect");
      const confirmCardBtn = document.getElementById("confirmCardBtn");
      const commandContainer = document.getElementById("commandContainer");
      const commandInput = document.getElementById("commandInput");
      const logEl = document.getElementById("log");

      const statEls = {
        health: [
          document.getElementById("p1-health"),
          document.getElementById("p2-health"),
        ],
        damageLimit: [
          document.getElementById("p1-damageLimit"),
          document.getElementById("p2-damageLimit"),
        ],
        shield: [
          document.getElementById("p1-shield"),
          document.getElementById("p2-shield"),
        ],
        block: [
          document.getElementById("p1-block"),
          document.getElementById("p2-block"),
        ],
        wild: [
          document.getElementById("p1-wild"),
          document.getElementById("p2-wild"),
        ],
      };

      const cardsByRarity = {
        COMMON: {
          "Kagamine Rin": { SP: 20, VR: 15 },
          "Kagamine Len": { SP: 20, VR: 20 },
          Meiko: { SP: 14, VR: 20 },
          Kaito: { SP: 10, VR: 20 },
          "Magurine Luka": { SP: 18, VR: 20 },
          "Yowane Haku": { SP: 18, VR: 20 },
        },
        EXTRA: {
          "Hatsune Miku": { SP: 25, VR: 25 },
          Gumi: { SP: 30, VR: 25 },
          "Kagumine Rin": { SP: 34, VR: 15 },
          Flower: { SP: 35, VR: 30 },
          Tohoko: { SP: 30, VR: 40 },
          Meiko: { SP: 24, VR: 20 },
          "Kagurime Len": { SP: 35, VR: 20 },
          "Magurine Luka": { SP: 27, VR: 20 },
          Kaito: { SP: 30, VR: 20 },
          "Anon & Kanon": { SP: 28, VR: 20 },
        },
        RARE: {
          "Hatsune Miku": { SP: 40, VR: 25 },
          Gumi: { SP: 45, VR: 25 },
          Rana: { SP: 40, VR: 25 },
          Tohoko: { SP: 42, VR: 40 },
          "Macne Nana": { SP: 48, VR: 10 },
          "Magurine Luka": { SP: 48, VR: 20 },
          "Kasane Teto": { SP: 45, VR: 35 },
          "Anon & Kanon": { SP: 38, VR: 20 },
          "Akoi Lapis": { SP: 48, VR: 20 },
        },
        LEGENDARY: {
          Gumi: { SP: 64, VR: 25 },
          Rana: { SP: 75, VR: 25 },
          Galaco: { SP: 80, VR: 30 },
          "Macne Nana": { SP: 78, VR: 10 },
          "Akita Neru": { SP: 65, VR: 30 },
          "Kaai Yuki": { SP: 80, VR: 20 },
          "Kasane Teto": { SP: 78, VR: 35 },
          Kokone: { SP: 80, VR: 45 },
        },
        UNTOUCHED: {
          Rana: { SP: 87, VR: 20 },
          Galaco: { SP: 97, VR: 30 },
          "Kasane Teto": { SP: 95, VR: 35 },
          CaseO: { SP: 98, VR: 20 },
          Kokone: { SP: 100, VR: 45 },
        },
      };

      const allCards = [];
      for (let rarity in cardsByRarity) {
        for (let name in cardsByRarity[rarity]) {
          allCards.push({ name, rarity, stats: cardsByRarity[rarity][name] });
        }
      }

      function log(msg) {
        const d = document.createElement("div");
        d.innerHTML = msg;
        logEl.appendChild(d);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function populateCardSelect() {
        cardSelect.innerHTML = "";
        allCards.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.name;
          opt.textContent = `[${c.rarity}] ${c.name}`;
          cardSelect.appendChild(opt);
        });
      }

      function renderStats() {
        ["P1", "P2"].forEach((p, i) => {
          statEls.health[i].textContent = players[p].health;
          statEls.damageLimit[i].textContent = players[p].damageLimit;
          statEls.shield[i].textContent = players[p].shield;
          statEls.block[i].textContent = players[p].block;
          statEls.wild[i].textContent = Object.values(players[p].wild).join(
            ", "
          );
        });
      }

      function assignWilds(p) {
        p.wild = {};
        ["attack", "defense", "health"].forEach((cat) => {
          const options = wildCards[cat];
          p.wild[cat] = options[Math.floor(Math.random() * options.length)];
        });
      }

      function checkForDraw() {
        if (players.P1.damageLimit <= 0 && players.P2.damageLimit <= 0) {
          const h1 = players.P1.health;
          const h2 = players.P2.health;
          if (h1 > h2)
            log(
              `<strong>${players.P1.username} wins with higher health!</strong>`
            );
          else if (h2 > h1)
            log(
              `<strong>${players.P2.username} wins with higher health!</strong>`
            );
          else log(`<strong>Draw! Both damage and health are equal.</strong>`);
          commandInput.disabled = true;
          return true;
        }
        return false;
      }

      function switchTurn() {
        if (players[turn].shieldFieldTurns > 0)
          players[turn].shieldFieldTurns--;
        turn = turn === "P1" ? "P2" : "P1";
        if (players[turn].shieldFieldTurns > 0)
          players[turn].shieldFieldTurns--;
        log(`<span class="highlight">Turn:</span> ${players[turn].username}`);
      }

      function processCommand(cmd) {
        const [action, ...rest] = cmd.trim().split(/\s+/);
        const param = rest.join(" ");
        const actor = players[turn];
        const defender = players[turn === "P1" ? "P2" : "P1"];

        if (action === "attack") {
          const val = parseInt(param, 10);
          if (isNaN(val) || actor.damageLimit < val)
            return log("Invalid attack");
          if (defender.pendingBlock) {
            defender.pendingBlock = false;
            log(`${defender.username} blocked the attack!`);
            switchTurn();
            return;
          }
          actor.damageLimit -= val;
          let dmg = val;
          if (defender.shieldFieldTurns > 0) {
            log(`${defender.username} is shielded; no damage taken.`);
            switchTurn();
            return;
          }
          if (defender.shield > 0) {
            const absorb = Math.min(defender.shield, dmg);
            defender.shield -= absorb;
            dmg -= absorb;
            log(
              `${actor.username} attacks ${val}, ${absorb} absorbed by shield.`
            );
          }
          if (dmg > 0) {
            defender.health = Math.max(0, defender.health - dmg);
            log(`${actor.username} deals ${dmg} damage to health.`);
            if (actor.looterActive) {
              const heal = Math.floor(dmg / 2);
              actor.health = Math.min(100, actor.health + heal);
              log(`${actor.username}'s Sideshot heals ${heal}.`);
              actor.looterActive = false;
            }
          }
        } else if (action === "block") {
          if (actor.block <= 0) return log("No blocks left");
          actor.block--;
          actor.pendingBlock = true;
          log(`${actor.username} blocks. Next attack will be canceled.`);
          if (actor.doubleBlockActive) {
            actor.block++;
            log(`${actor.username} gains an extra block (Double Block).`);
            actor.doubleBlockActive = false;
          }
        } else if (action === "wild") {
          if (actor.wild.attack === param) {
            if (param === "Vocal Buster") {
              defender.shield = 0;
              log(`${actor.username} uses Vocal Buster to destroy shield.`);
            } else if (param === "Sideshot") {
              actor.looterActive = true;
              log(`${actor.username} activates Sideshot for next heal.`);
            }
            actor.wild.attack = null;
          } else if (actor.wild.defense === param) {
            if (param === "Shield Field") {
              actor.shieldFieldTurns = 2;
              log(`${actor.username} is shielded for 2 turns.`);
            } else if (param === "Double Block") {
              actor.doubleBlockActive = true;
              log(`${actor.username} activates Double Block.`);
            }
            actor.wild.defense = null;
          } else if (actor.wild.health === param) {
            const amt = parseInt(param.replace(/\D/g, ""), 10);
            if (actor.health >= 100) return log("Health already full");
            actor.health = Math.min(100, actor.health + amt);
            log(`${actor.username} heals ${amt} HP.`);
            actor.wild.health = null;
          } else {
            return log("Invalid wild card");
          }
        } else {
          return log("Unknown command");
        }

        renderStats();

        if (defender.health <= 0) {
          log(`<strong>${actor.username} wins!</strong>`);
          commandInput.disabled = true;
        } else if (!checkForDraw()) {
          switchTurn();
        }
      }

      startBtn.addEventListener("click", () => {
        if (stage === "usernames") {
          const names = usernameInput.value.trim().split(/\s+/);
          if (names.length < 2) return log("Enter two usernames");
          players.P1.username = names[0];
          players.P2.username = names[1];
          document.getElementById("player1-name").textContent = names[0];
          document.getElementById("player2-name").textContent = names[1];
          usernameInput.disabled = true;
          populateCardSelect();
          cardSelectContainer.style.display = "block";
          stage = "cardSelect";
          log(`Choose card for ${players.P1.username}`);
        }
      });

      confirmCardBtn.addEventListener("click", () => {
        const selected = cardSelect.value;
        const data = allCards.find((c) => c.name === selected);
        const p = players[currentPicker];
        p.card = selected;
        p.health = p.damageLimit = data.stats.SP;
        p.shield = data.stats.VR;
        p.block = 1;
        p.pendingBlock = false;
        p.shieldFieldTurns = 0;
        p.doubleBlockActive = false;
        p.looterActive = false;

        if (currentPicker === "P1") {
          currentPicker = "P2";
          log(`Choose card for ${players.P2.username}`);
        } else {
          assignWilds(players.P1);
          assignWilds(players.P2);
          log(
            `Wilds Assigned<br>${players.P1.username}: ${Object.values(
              players.P1.wild
            ).join(", ")}<br>${players.P2.username}: ${Object.values(
              players.P2.wild
            ).join(", ")}`
          );
          cardSelectContainer.style.display = "none";
          commandContainer.style.display = "block";
          startBtn.style.display = "none";
          turn = "P1";
          log(`<strong>Game Start!</strong> ${players.P1.username} begins.`);
          renderStats();
        }
      });

      commandInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          processCommand(commandInput.value.trim());
          commandInput.value = "";
        }
      });
    </script>
  </body>
</html>
