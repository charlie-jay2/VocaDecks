<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/Assets/favicon.ico" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <style>
      @font-face {
        font-family: "Panton";
        src: url("./Fonts/Panton.otf") format("truetype");
        font-display: swap;
      }

      @font-face {
        font-family: "NewMedia";
        src: url("./Fonts/NewMedia.ttf") format("truetype");
        font-display: swap;
      }

      body {
        margin: 0;
        font-family: Panton, sans-serif;
        background: url(./Menu/bg.png) center/cover fixed no-repeat;
        overflow: hidden;
        color: white;
        transition: background 0.8s ease;
      }

      .bg,
      .bg2,
      .t1,
      .t2,
      .t3,
      .t4,
      .t5,
      .t6,
      .levelb,
      .synthcl {
        max-width: 100%;
        height: auto;
      }

      .bg {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: calc(100% - 80px);
        max-height: calc(100% - 80px);
        object-fit: contain;
        z-index: -1;
      }

      .bg2 {
        position: fixed;
        top: 53%;
        left: 74%;
        transform: translate(-50%, -50%);
        max-width: calc(100% - 80px);
        max-height: calc(105% - 80px);
        object-fit: contain;
        z-index: -1;
      }

      .t1,
      .t2,
      .t3,
      .t4,
      .t5,
      .t6 {
        cursor: pointer;
        border: 8px solid transparent;
        border-radius: 15px;
        transition: border 0.3s ease;
        position: fixed;
        max-width: calc(23% - 80px);
        max-height: calc(100% - 80px);
        object-fit: contain;
        z-index: 0;
      }

      .t1 {
        top: 31%;
        left: 63%;
        transform: translate(-50%, -50%);
      }
      .t2 {
        top: 54%;
        left: 63%;
        transform: translate(-50%, -50%);
      }
      .t3 {
        top: 77%;
        left: 63%;
        transform: translate(-50%, -50%);
      }
      .t4 {
        top: 31%;
        left: 85%;
        transform: translate(-50%, -50%);
      }
      .t5 {
        top: 54%;
        left: 85%;
        transform: translate(-50%, -50%);
      }
      .t6 {
        top: 77%;
        left: 85%;
        transform: translate(-50%, -50%);
      }

      .t1t,
      .t2t,
      .t3t,
      .t4t,
      .t5t,
      .t6t {
        position: absolute;
        font-size: 30px;
      }
      .t1t {
        top: 39.3%;
        left: 53.6%;
      }
      .t2t {
        top: 62%;
        left: 57%;
      }
      .t3t {
        top: 85%;
        left: 57%;
      }
      .t4t {
        top: 39.3%;
        left: 76%;
      }
      .t5t {
        top: 62%;
        left: 78%;
      }
      .t6t {
        top: 85%;
        left: 80%;
      }

      .theme {
        position: absolute;
        top: 14%;
        left: 53.5%;
        font-size: 40px;
      }

      .active-theme {
        border-color: rgb(245, 228, 130);
      }

      .levelb {
        position: absolute;
        top: 6%;
        left: 53%;
        font-size: 40px;
        width: auto;
        height: 8%;
      }

      .pfp {
        position: absolute;
        top: 7%;
        left: 4%;
        width: 120px;
        height: 120px;
        background-color: white;
        border-radius: 50%;
        overflow: hidden;
      }

      .name {
        position: absolute;
        top: 8%;
        left: 11%;
        font-size: 50px;
      }

      .level {
        position: absolute;
        top: 20%;
        left: 4%;
        font-size: 80px;
      }

      .synthct {
        position: absolute;
        top: 34%;
        left: 4%;
        font-size: 80px;
      }

      .synthcl {
        position: absolute;
        top: 45%;
        left: 4%;
        width: auto;
        height: 8%;
      }

      .synthc {
        position: absolute;
        top: 43%;
        left: 7%;
        font-size: 76px;
        font-family: NewMedia;
      }

      .battlew {
        position: absolute;
        top: 54%;
        left: 4%;
        font-size: 80px;
      }

      .battlewn {
        position: absolute;
        top: 63%;
        left: 4%;
        font-size: 76px;
        font-family: NewMedia;
      }

      .battlel {
        position: absolute;
        top: 72%;
        left: 4%;
        font-size: 80px;
      }

      .battleln {
        position: absolute;
        top: 81%;
        left: 4%;
        font-size: 76px;
        font-family: NewMedia;
      }

      .pb {
        position: absolute;
        top: 31.3%;
        left: 4%;
        width: 670px;
        height: 30px;
        background-color: white;
        border-radius: 25px;
        overflow: hidden;
      }

      .pb-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #29ff52 0%, #40e0d0 100%);
        transition: width 0.5s ease-in-out, background 0.8s ease-in-out;
      }

      .logout {
        position: absolute;
        top: 5%;
        left: 85%;
        font-size: 50px;
        width: auto;
        border-radius: 15px;
        height: 10%;
        width: auto;
        color: black;
        font-size: 27px;
        transition: 0.3s ease-in-out;
      }

      .logout:hover {
        scale: 1.2;
        cursor: pointer;
      }

      .back {
        width: auto;
        height: 50px;
        position: absolute;
        top: 0.5%;
        left: 0.5%;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-0">
      <img src="Profile/Rectangle_164.png" class="bg img-responsive" />
      <img src="Profile/Rectangle_166.png" class="bg2 img-responsive" />

      <div>
        <h1 class="theme">THEME</h1>
        <img
          src="Menu/bg.png"
          class="t1 img-responsive"
          onclick="setTheme('t1')" />
        <img
          src="Profile/MIDNIGHT_BLUE.png"
          class="t2 img-responsive"
          onclick="setTheme('t2')" />
        <img
          src="Profile/TUNDRA_MANGO.png"
          class="t3 img-responsive"
          onclick="setTheme('t3')" />
        <img
          src="Profile/RADIANT_ROCKET_LOLLY.png"
          class="t4 img-responsive"
          onclick="setTheme('t4')" />
        <img
          src="Profile/CHERRIES__CREAM.png"
          class="t5 img-responsive"
          onclick="setTheme('t5')" />
        <img
          src="Profile/SIREN_PURPLE.png"
          class="t6 img-responsive"
          onclick="setTheme('t6')" />

        <h1 class="t1t">SUMMER CYAN (DEFAULT)</h1>
        <h1 class="t2t">MIDNIGHT BLUE</h1>
        <h1 class="t3t">TUNDRA MANGO</h1>
        <h1 class="t4t">RADIANT ROCKET LOLLY</h1>
        <h1 class="t5t">CHERRIES & CREAM</h1>
        <h1 class="t6t">SIREN PURPLE</h1>
      </div>

      <img src="./Profile/C.png" class="levelb img-responsive" />
      <div class="pfp"></div>
      <h1 class="name">USERNAME</h1>
      <h1 class="level">LEVEL: 000</h1>
      <div class="pb">
        <div class="pb-fill"></div>
      </div>
      <h1 class="synthct">SYNTH CREDITS</h1>
      <img src="./Profile/SynthCredits.png" class="synthcl img-responsive" />
      <h1 class="synthc">00,000,000</h1>
      <h1 class="battlew">BATTLES WON:</h1>
      <h1 class="battlewn">00,000,000</h1>
      <h1 class="battlel">BATTLES LOST:</h1>
      <h1 class="battleln">00,000,000</h1>
    </div>
    <div>
      <img src="./menu/LOGOUT.png" class="logout" />
      <img
        src="./Assets/ICONS/back.png"
        class="back"
        onclick="window.location.href='menu.html'" />
    </div>
    <script>
      // --- Load SFX and Music Volumes from localStorage ---
      let sfxVolumeStored = localStorage.getItem("sfxVolume");
      let sfxVolume =
        sfxVolumeStored !== null ? parseFloat(sfxVolumeStored) : 0.1;

      let musicVolumeStored = localStorage.getItem("bgMusicVolume");
      let musicVolume =
        musicVolumeStored !== null ? parseFloat(musicVolumeStored) : 0.1;

      const hoverSound = new Audio("Menu/Back.wav");
      const clickSound = new Audio("Menu/Okay.wav");
      const bgMusic = new Audio("Menu/Challenger_Junction_VocaDecks_Theme.wav");

      bgMusic.loop = true;
      hoverSound.volume = sfxVolume;
      clickSound.volume = sfxVolume;
      bgMusic.volume = musicVolume;

      const savedTimeStored = localStorage.getItem("bgMusicTime");
      const savedTime =
        savedTimeStored !== null ? parseFloat(savedTimeStored) : 0;
      bgMusic.currentTime = savedTime;

      setInterval(() => {
        if (!isNaN(bgMusic.currentTime)) {
          localStorage.setItem("bgMusicTime", bgMusic.currentTime);
        }
      }, 500);

      window.addEventListener("load", () => {
        bgMusic.play().catch(() => {
          document.body.addEventListener("click", () => bgMusic.play(), {
            once: true,
          });
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
    <script>
      function isTokenValid(token) {
        try {
          const decoded = jwt_decode(token);
          return decoded.exp * 1000 > Date.now();
        } catch {
          return false;
        }
      }

      function renderLoggedOut() {
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }

      document.querySelector(".logout").addEventListener("click", () => {
        renderLoggedOut();
      });

      (function () {
        const token = localStorage.getItem("token");
        if (!token || !isTokenValid(token)) {
          renderLoggedOut();
        }
      })();

      const themes = {
        t1: {
          bg: "./Menu/bg.png",
          gradient: ["#40e0d0", "#29ff52"],
        },
        t2: {
          bg: "./Profile/MIDNIGHT_BLUE.png",
          gradient: ["#e393ff", "#1b11fc"],
        },
        t3: {
          bg: "./Profile/TUNDRA_MANGO.png",
          gradient: ["#f16300", "#09b313"],
        },
        t4: {
          bg: "./Profile/RADIANT_ROCKET_LOLLY.png",
          gradient: ["#d01ae6", "#ebf415"],
        },
        t5: {
          bg: "./Profile/CHERRIES__CREAM.png",
          gradient: ["#ff54c0", "#ffe1e4"],
        },
        t6: {
          bg: "./Profile/SIREN_PURPLE.png",
          gradient: ["#ec1927", "#0617af"],
        },
      };

      let lastChange = 0;

      function setTheme(key) {
        const now = Date.now();
        if (now - lastChange < 1000) return;
        lastChange = now;

        document.body.style.background = `url(${themes[key].bg}) center/cover fixed no-repeat`;

        const [start, end] = themes[key].gradient;
        document.querySelector(
          ".pb-fill"
        ).style.background = `linear-gradient(90deg, ${start} 0%, ${end} 100%)`;

        document
          .querySelectorAll(".t1, .t2, .t3, .t4, .t5, .t6")
          .forEach((el) => el.classList.remove("active-theme"));
        document.querySelector("." + key).classList.add("active-theme");

        localStorage.setItem("selectedTheme", key);
      }

      function getXpForLevel(level) {
        return level * 50;
      }

      async function loadUserData() {
        try {
          const response = await fetch("/.netlify/functions/getUserData", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          if (!response.ok) throw new Error("Failed to fetch user data");
          const data = await response.json();

          document.querySelector(".name").textContent = data.username;
          document.querySelector(".level").textContent = `LEVEL: ${data.level
            .toString()
            .padStart(3, "0")}`;
          document.querySelector(".synthc").textContent =
            data.points.toLocaleString();
          document.querySelector(".battlewn").textContent =
            data.battlesWon.toLocaleString();
          document.querySelector(".battleln").textContent =
            data.battlesLost.toLocaleString();

          const neededXp = getXpForLevel(data.level);
          const progress = Math.min(data.xp / neededXp, 0.99);
          document.querySelector(".pb-fill").style.width = `${progress * 100}%`;

          // level badge
          const badge = document.querySelector(".levelb");
          let src = "./Profile/C.png";
          if (data.level >= 1 && data.level <= 10) src = "./Profile/C.png";
          else if (data.level <= 40) src = "./Profile/E.png";
          else if (data.level <= 90) src = "./Profile/R.png";
          else if (data.level <= 110) src = "./Profile/L.png";
          else if (data.level < 200) src = "./Profile/U.png";
          else if (data.level === 200) src = "./Profile/I.png";
          badge.src = src;

          // Discord avatar
          const pfpDiv = document.querySelector(".pfp");
          pfpDiv.innerHTML = `<img src="${data.avatar}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" />`;
        } catch (err) {
          console.error("Error loading user data:", err);
        }
      }

      window.addEventListener("load", () => {
        const saved = localStorage.getItem("selectedTheme") || "t1";
        setTheme(saved);
        loadUserData();
        setInterval(loadUserData, 5000);
      });
    </script>
  </body>
</html>
