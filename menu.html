<html>
  <head>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @font-face {
        font-family: "Panton";
        src: url("./Fonts/Panton.otf") format("truetype");
        font-display: swap;
      }
      body {
        margin: 0;
        font-family: Panton, sans-serif;
        background: url(./Profile/bg.png) center/cover fixed no-repeat;
        overflow: hidden;
        transition: background 0.8s ease;
      }

      .logotop {
        width: 30%;
        position: fixed;
        transform: translate(-50%, -50%);
        left: 17%;
        top: 7%;
        height: auto;
      }

      .logobot {
        width: 37%;
        position: fixed;
        transform: translate(-50%, -50%);
        left: 19.5%;
        top: 16%;
        height: auto;
      }

      /* Buttons */
      .cbtn {
        width: 40%;
        position: fixed;
        transform: translate(-50%, -50%);
        left: 16.5%;
        top: 32%;
        height: auto;
        transition: 0.3s ease-in-out;
      }

      .grbtn {
        width: 40%;
        position: fixed;
        transform: translate(-50%, -50%);
        left: 14%;
        top: 50%;
        height: auto;
        transition: 0.3s ease-in-out;
      }

      .cbtn:hover {
        left: 20%;
      }

      .grbtn:hover {
        left: 19%;
      }

      .settings {
        width: 4%;
        position: fixed;
        transform: translate(-50%, -50%);
        left: 3%;
        top: 95%;
        height: auto;
        transition: 0.3s ease-in-out;
      }

      .profile {
        width: 4%;
        position: fixed;
        transform: translate(-50%, -50%);
        left: 8%;
        top: 95%;
        height: auto;
        transition: 0.3s ease-in-out;
      }

      .settings:hover {
        width: 5%;
        top: 90%;
        filter: hue-rotate(240deg);
      }

      .profile:hover {
        width: 5%;
        top: 90%;
        filter: hue-rotate(240deg);
      }

      /* Card Images (hidden by default) */
      .solo,
      .goldrush,
      .infocl,
      .infogr {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.8s ease;
      }

      .solo.show,
      .goldrush.show,
      .infocl.show,
      .infogr.show {
        opacity: 1;
        pointer-events: auto;
      }

      .solo,
      .goldrush {
        width: 50%;
        position: fixed;
        left: 65%;
        top: 52%;
        transform: translate(-50%, -50%);
        height: auto;
      }

      .infocl,
      .infogr {
        width: 33%;
        position: fixed;
        left: 17.5%;
        top: 70%;
        transform: translate(-50%, -50%);
        height: auto;
      }

      /* === GREETINGS === */

      .surprised,
      .sad,
      .happy {
        position: fixed;
        top: 50%;
        left: 70%;
        transform: translate(-50%, -50%);
        width: 25%;
        height: auto;
      }

      .happyrec {
        position: fixed;
        top: 20%;
        left: 65%;
        transform: translate(-50%, -50%);
        width: 25%;
        height: auto;
      }

      .sadrec {
        position: fixed;
        top: 10%;
        left: 58%;
        rotate: -40deg;
        transform: translate(-50%, -50%);
        width: 25%;
        height: auto;
      }

      .surprisedrec {
        position: fixed;
        top: 10%;
        left: 58%;
        rotate: -40deg;
        transform: translate(-50%, -50%);
        width: 25%;
        height: auto;
      }

      .happyt {
        position: fixed;
        top: 14%;
        left: 65%;
        font-size: 2.2rem;
        transform: translate(-50%, -50%);
        height: auto;
      }

      .sadt {
        position: fixed;
        top: 9%;
        left: 54%;
        rotate: -40deg;
        transform: translate(-50%, -50%);
        font-size: 2.5rem;
        height: auto;
      }

      .surprisedt {
        position: fixed;
        top: 13.5%;
        left: 56%;
        rotate: -40deg;
        transform: translate(-50%, -50%);
        font-size: 2.5rem;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="logo">
      <img src="./Menu/VOCADECKS_LOGO_NO_GLINT_314.png" class="logotop" />
      <img src="./Menu/SERIES_1.png" class="logobot" />
    </div>

    <!-- === GREETINGS BOX === -->
    <div class="greetings">
      <div class="girls">
        <img src="./Menu/Greetings/HAPPY_GREETING.png" class="happy" />
        <img src="./Menu/Greetings/SAD_GREETING.png" class="sad" />
        <img src="./Menu/Greetings/SURPRISED_GREETING.png" class="surprised" />
      </div>

      <!-- Textboxes with text stacked on top -->
      <div class="textbox happybox">
        <img src="./Menu/Greetings/Rectangle_213.png" class="happyrec" />
        <h1 class="happyt">Hey {Username} lets spin <br />some decks</h1>
      </div>

      <div class="textbox sadbox">
        <img src="./Menu/Greetings/Rectangle_213.png" class="sadrec" />
        <h1 class="sadt">I lost my favourite card ＞﹏＜</h1>
      </div>

      <div class="textbox surprisedbox">
        <img src="./Menu/Greetings/Rectangle_213.png" class="surprisedrec" />
        <h1 class="surprisedt">Yo {Username}, <br />look how rich I am</h1>
      </div>
    </div>

    <script>
      // Define the sets (each includes image, rectangle, and text element)
      const sets = [
        ["happy", "happyrec", "happyt"],
        ["sad", "sadrec", "sadt"],
        ["surprised", "surprisedrec", "surprisedt"],
      ];

      // Hide everything initially
      sets.flat().forEach((cls) => {
        const el = document.querySelector("." + cls);
        if (el) {
          el.style.opacity = 0;
        }
      });

      // Fetch username from server (fallback = "MikuDayo")
      async function fetchUsername() {
        try {
          const res = await fetch("/.netlify/functions/getUserData", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("jwtToken") || ""}`,
            },
          });
          if (!res.ok) throw new Error("Network response not ok");
          const data = await res.json();
          return data.username || "MikuDayo";
        } catch (e) {
          console.error("Failed to fetch username:", e);
          return "MikuDayo";
        }
      }

      // Show one random set (different each load)
      async function showRandomSet() {
        const newSet = sets[Math.floor(Math.random() * sets.length)];

        // Make selected set visible
        newSet.forEach((cls) => {
          const el = document.querySelector("." + cls);
          if (el) el.style.opacity = 1;
        });

        // Update greeting text depending on set
        const username = await fetchUsername();
        if (newSet.includes("happyt")) {
          const speechEl = document.querySelector(".happyt");
          if (speechEl)
            speechEl.innerHTML = `Hey ${username},<br>Let's spin some decks!<br>`;
        } else if (newSet.includes("sadt")) {
          const speechEl = document.querySelector(".sadt");
          if (speechEl)
            speechEl.innerHTML = `Cheer up ${username},<br>things will get better.<br>`;
        } else if (newSet.includes("surprisedt")) {
          const speechEl = document.querySelector(".surprisedt");
          if (speechEl)
            speechEl.innerHTML = `${username},<br>look how rich I am!<br>`;
        }
      }

      // Run on page load
      document.addEventListener("DOMContentLoaded", showRandomSet);
    </script>

    <script>
      async function fetchUsername() {
        try {
          const res = await fetch("/.netlify/functions/getUserData", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("jwtToken") || ""}`,
            },
          });
          if (!res.ok) throw new Error("Network response not ok");
          const data = await res.json();
          return data.username || "MikuDayo";
        } catch (e) {
          console.error("Failed to fetch username:", e);
          return "MikuDayo";
        }
      }

      // Update Happy Bubble
      const speechTextEl = document.querySelector(".speech-text");
      fetchUsername().then((username) => {
        speechTextEl.textContent = `Hey ${username},\nLet's spin some decks!`;
      });

      // Update Surprised Bubble
      const speechText1El = document.querySelector(".speech-text1");
      fetchUsername().then((username) => {
        speechText1El.textContent = `${username},\nlook how rich I am!`;
      });
    </script>

    <div class="buttons">
      <img src="./Menu/CLASSIC_BUTTON.png" class="cbtn" />
      <img src="./Menu/GOLD_RUSH_BUTTON.png" class="grbtn" />
      <a href="./settings.html"
        ><img src="./Menu/SETTINGS_BUTTON.png" class="settings"
      /></a>
      <a href="./profile.html"
        ><img src="./Menu/PROFILE_BUTTON.png" class="profile"
      /></a>
    </div>

    <div class="cards">
      <img src="./Menu/SOLO_IMAGE.png" class="solo" />
      <img src="./Menu/GOLD_RUSH_IMAGE.png" class="goldrush" />
    </div>

    <div class="description">
      <img src="./Menu/INFORMATION.png" class="infocl" />
      <img src="./Menu/INFORMATION_GOLD_RUSH.png" class="infogr" />
    </div>

    <script>
      // --- Load SFX and Music Volumes from localStorage ---
      let sfxVolume = parseFloat(localStorage.getItem("sfxVolume")) || 0.1;
      let musicVolume =
        parseFloat(localStorage.getItem("bgMusicVolume")) || 0.1;

      const hoverSound = new Audio("Menu/Back.wav");
      const clickSound = new Audio("Menu/Okay.wav");
      const bgMusic = new Audio("Menu/Challenger_Junction_VocaDecks_Theme.wav");

      bgMusic.loop = true;
      hoverSound.volume = sfxVolume;
      clickSound.volume = sfxVolume;
      bgMusic.volume = musicVolume;

      const savedTime = parseFloat(localStorage.getItem("bgMusicTime")) || 0;
      bgMusic.currentTime = savedTime;

      setInterval(() => {
        if (!isNaN(bgMusic.currentTime)) {
          localStorage.setItem("bgMusicTime", bgMusic.currentTime);
        }
      }, 500);

      window.addEventListener("load", () => {
        bgMusic.play().catch(() => {
          document.body.addEventListener("click", () => bgMusic.play(), {
            once: true,
          });
        });
      });

      function playClickAndNavigate(e) {
        e.preventDefault();
        const targetUrl = e.currentTarget.href;

        clickSound.currentTime = 0;
        clickSound.volume = sfxVolume;
        clickSound
          .play()
          .then(() => {
            clickSound.onended = () => {
              if (targetUrl) window.location.href = targetUrl;
            };
          })
          .catch(() => {
            if (targetUrl) window.location.href = targetUrl;
          });
      }

      const buttons = [
        document.querySelector(".cbtn"),
        document.querySelector(".grbtn"),
        document.querySelector(".settings").parentElement,
        document.querySelector(".profile").parentElement,
      ];

      buttons.forEach((btn) => {
        if (!btn) return;
        btn.addEventListener("click", playClickAndNavigate);
        btn.addEventListener("mouseenter", () => {
          hoverSound.currentTime = 0;
          hoverSound.volume = sfxVolume;
          hoverSound.play();
        });
      });

      const cbtn = document.querySelector(".cbtn");
      const grbtn = document.querySelector(".grbtn");
      const solo = document.querySelector(".solo");
      const infocl = document.querySelector(".infocl");
      const goldrush = document.querySelector(".goldrush");
      const infogr = document.querySelector(".infogr");

      cbtn.addEventListener("mouseenter", () => {
        solo.classList.add("show");
        infocl.classList.add("show");
      });
      cbtn.addEventListener("mouseleave", () => {
        solo.classList.remove("show");
        infocl.classList.remove("show");
      });

      grbtn.addEventListener("mouseenter", () => {
        goldrush.classList.add("show");
        infogr.classList.add("show");
      });
      grbtn.addEventListener("mouseleave", () => {
        goldrush.classList.remove("show");
        infogr.classList.remove("show");
      });

      let t = 0;
      function animate() {
        t += 0.02;
        const offsetY1 = Math.sin(t) * 50;
        const angle1 = Math.sin(t / 2) * 5;
        const offsetY2 = Math.sin(t + Math.PI) * 50;
        const angle2 = Math.sin((t + Math.PI) / 2) * 5;

        solo.style.transform = `translate(-50%, calc(-50% + ${offsetY1}px)) rotate(${angle1}deg)`;
        goldrush.style.transform = `translate(-50%, calc(-50% + ${offsetY2}px)) rotate(${angle2}deg)`;

        requestAnimationFrame(animate);
      }
      animate();
    </script>
  </body>
</html>
