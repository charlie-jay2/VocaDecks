<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Combined Web App</title>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fonts -->
    <style>
      @font-face {
        font-family: "Panton";
        src: url("./Fonts/Panton.otf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "NewMedia";
        src: url("./Fonts/NewMedia.ttf") format("truetype");
        font-display: swap;
      }
    </style>

    <!-- Combined Styles -->
    <style>
      /* ---------- Common body styles ---------- */
      body {
        margin: 0;
        font-family: Panton, sans-serif;
        overflow: hidden;
        color: white;
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        transition: background 0.8s ease;
      }

      /* Hide all sections by default */
      section {
        display: none;
        width: 100vw;
        height: 100vh;
        position: relative;
      }
      section.active {
        display: block;
      }

      /* ---------- Index.html styles ---------- */
      #index {
        background-image: url(./Login/bg.png);
        overflow-y: hidden;
        overflow-x: hidden;
      }

      .dc,
      .join,
      .invite {
        position: absolute;
        width: auto;
        height: 12%;
        cursor: pointer;
        transition: transform 0.3s ease-in-out, filter 0.3s ease-in-out;
      }

      .dc {
        top: 34%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .join {
        top: 80%;
        left: 20%;
        transform: translate(-50%, -50%);
      }

      .invite {
        top: 80%;
        left: 80%;
        transform: translate(-50%, -50%);
      }

      .dc:hover {
        transform: translate(-50%, -50%) scale(1.1);
        filter: drop-shadow(0 0 20px #5865f2);
      }

      .join:hover {
        transform: translate(-50%, -52%) scale(1.15);
      }

      .invite:hover {
        transform: translate(-50%, -50%) rotate(5deg) scale(1.1);
      }

      /* ---------- Menu.html styles ---------- */
      #menu {
        overflow: hidden;
        background: url(./Menu/bg.png) center/cover fixed no-repeat;
      }

      /* Shared screens styles moved to menu-specific inside #menu section */

      .menu-screen,
      .selection-screen,
      .rarity-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      }

      /* MENU SCREEN */
      .menu-screen img {
        position: absolute;
        transition: all 1s ease;
        cursor: pointer;
      }
      .trad {
        top: 65%;
        left: 17%;
        transform: translate(-50%, -50%);
        height: 70%;
        transition: transform 0.6s ease, opacity 0.6s ease;
      }
      .battle {
        top: 65%;
        left: 80%;
        transform: translate(-50%, -50%);
        height: 70%;
        transition: transform 0.6s ease, opacity 0.6s ease;
      }
      .menu-line {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: transform 0.8s ease, opacity 0.8s ease;
      }
      .menu-logo {
        top: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        height: 10%;
        transition: transform 0.8s ease, opacity 0.8s ease;
      }

      /* SELECTION SCREEN (hidden initially) */
      .selection-screen {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.8s ease 0.2s;
      }
      .selection-screen.active {
        opacity: 1;
        pointer-events: all;
      }

      /* Welcome text */
      .fade-in-content {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 2em;
        opacity: 0;
        transition: opacity 1s ease;
      }
      .fade-in-content.visible {
        opacity: 1;
      }
      .fade-in-content.slide-up {
        transition: top 1s ease;
        top: 10%;
      }

      /* PVB/PVP assets (hidden initially) */
      .pvb,
      .pvp,
      .pvbse,
      .pvpse {
        position: absolute;
        opacity: 0;
        transition: opacity 1s ease, transform 0.8s ease;
        cursor: pointer;
      }
      .pvb {
        top: 40%;
        left: 60%;
        transform: translate(-50%, -50%);
        height: 30%;
      }
      .pvp {
        top: 75%;
        left: 60%;
        transform: translate(-50%, -50%);
        height: 30%;
      }
      .pvbse {
        top: 49%;
        left: 79%;
        transform: translate(-50%, -50%);
        height: 8%;
      }
      .pvpse {
        top: 84%;
        left: 79%;
        transform: translate(-50%, -50%);
        height: 8%;
      }

      .pvbse:hover,
      .pvpse:hover {
        animation: intricate-hover 0.8s ease-in-out forwards;
      }

      @keyframes intricate-hover {
        0% {
          transform: translate(-50%, -50%) scale(1) rotate(0);
        }
        25% {
          transform: translate(-50%, -60%) scale(1.1) rotate(-5deg);
        }
        50% {
          transform: translate(-50%, -45%) scale(1.05) rotate(5deg);
        }
        75% {
          transform: translate(-50%, -58%) scale(1.1) rotate(-5deg);
        }
        100% {
          transform: translate(-50%, -50%) scale(1) rotate(0);
        }
      }

      /* RARITY SCREEN (hidden initially) */
      .rarity-screen {
        transform: translateX(100vw);
        transition: transform 0.8s ease;
        pointer-events: none;
      }
      .rarity-screen.active {
        transform: translateX(0);
        pointer-events: all;
      }

      .par {
        width: auto;
        height: 20%;
        position: absolute;
        left: 50%;
        top: 15%;
        transform: translate(-50%, -50%);
      }
      .rarity {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2vw;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .rarity img {
        height: 80%;
        max-height: 230px;
        width: auto;
        transition: transform 0.3s ease;
        cursor: pointer;
      }
      .rarity img:hover {
        transform: scale(1.1);
      }

      /* Swipe targets */
      .swipe-line {
        top: 50%;
        left: 10%;
        transform: translate(-50%, -50%);
      }
      .swipe-logo {
        top: 30%;
        left: 13%;
        transform: translate(-50%, -50%) rotate(-57.5deg);
        height: 8%;
      }

      /* Profile picture in top right */
      #profile-pic {
        position: fixed;
        top: 10px;
        right: 26px;
        width: 90px;
        height: 90px;
        border-radius: 50%;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
        z-index: 9999;
        cursor: pointer;
        display: none;
      }

      /* ---------- Profile.html styles ---------- */
      #profile {
        background: url(./Menu/bg.png) center/cover fixed no-repeat;
        overflow: hidden;
        color: white;
        font-family: Panton, sans-serif;
        transition: background 0.8s ease;
        position: relative;
      }

      .bg,
      .bg2,
      .t1,
      .t2,
      .t3,
      .t4,
      .t5,
      .t6,
      .levelb,
      .synthcl {
        max-width: 100%;
        height: auto;
      }

      .bg {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: calc(100% - 80px);
        max-height: calc(100% - 80px);
        object-fit: contain;
        z-index: -1;
      }

      .bg2 {
        position: fixed;
        top: 53%;
        left: 74%;
        transform: translate(-50%, -50%);
        max-width: calc(100% - 80px);
        max-height: calc(105% - 80px);
        object-fit: contain;
        z-index: -1;
      }

      .t1,
      .t2,
      .t3,
      .t4,
      .t5,
      .t6 {
        cursor: pointer;
        border: 8px solid transparent;
        border-radius: 15px;
        transition: border 0.3s ease;
        position: fixed;
        max-width: calc(23% - 80px);
        max-height: calc(100% - 80px);
        object-fit: contain;
        z-index: 0;
      }

      .t1 {
        top: 31%;
        left: 63%;
        transform: translate(-50%, -50%);
      }
      .t2 {
        top: 54%;
        left: 63%;
        transform: translate(-50%, -50%);
      }
      .t3 {
        top: 77%;
        left: 63%;
        transform: translate(-50%, -50%);
      }
      .t4 {
        top: 31%;
        left: 85%;
        transform: translate(-50%, -50%);
      }
      .t5 {
        top: 54%;
        left: 85%;
        transform: translate(-50%, -50%);
      }
      .t6 {
        top: 77%;
        left: 85%;
        transform: translate(-50%, -50%);
      }

      .t1t,
      .t2t,
      .t3t,
      .t4t,
      .t5t,
      .t6t {
        position: absolute;
        font-size: 30px;
      }
      .t1t {
        top: 39.3%;
        left: 53.6%;
      }
      .t2t {
        top: 62%;
        left: 57%;
      }
      .t3t {
        top: 85%;
        left: 57%;
      }
      .t4t {
        top: 39.3%;
        left: 76%;
      }
      .t5t {
        top: 62%;
        left: 78%;
      }
      .t6t {
        top: 85%;
        left: 80%;
      }

      .theme {
        position: absolute;
        top: 14%;
        left: 53.5%;
        font-size: 40px;
      }

      .active-theme {
        border-color: rgb(245, 228, 130);
      }

      .levelb {
        position: absolute;
        top: 6%;
        left: 53%;
        font-size: 40px;
        width: auto;
        height: 8%;
      }

      .pfp {
        position: absolute;
        top: 7%;
        left: 4%;
        width: 120px;
        height: 120px;
        background-color: white;
        border-radius: 50%;
        overflow: hidden;
      }

      .name {
        position: absolute;
        top: 8%;
        left: 11%;
        font-size: 50px;
      }

      .level {
        position: absolute;
        top: 20%;
        left: 4%;
        font-size: 80px;
      }

      .synthct {
        position: absolute;
        top: 34%;
        left: 4%;
        font-size: 80px;
      }

      .synthcl {
        position: absolute;
        top: 45%;
        left: 4%;
        width: auto;
        height: 8%;
      }

      .synthc {
        position: absolute;
        top: 43%;
        left: 7%;
        font-size: 76px;
        font-family: NewMedia;
      }

      .battlew {
        position: absolute;
        top: 54%;
        left: 4%;
        font-size: 80px;
      }

      .battlewn {
        position: absolute;
        top: 63%;
        left: 4%;
        font-size: 76px;
        font-family: NewMedia;
      }

      .battlel {
        position: absolute;
        top: 72%;
        left: 4%;
        font-size: 80px;
      }

      .battleln {
        position: absolute;
        top: 81%;
        left: 4%;
        font-size: 76px;
        font-family: NewMedia;
      }

      .pb {
        position: absolute;
        top: 31.3%;
        left: 4%;
        width: 670px;
        height: 30px;
        background-color: white;
        border-radius: 25px;
        overflow: hidden;
      }

      .pb-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #29ff52 0%, #40e0d0 100%);
        transition: width 0.5s ease-in-out, background 0.8s ease-in-out;
      }

      .logout {
        position: absolute;
        top: 7%;
        left: 90%;
        font-size: 27px;
        width: auto;
        border-radius: 15px;
        height: 6%;
        color: black;
        background-color: red;
      }

      .back {
        width: auto;
        height: 50px;
        position: absolute;
        top: 0.5%;
        left: 0.5%;
        cursor: pointer;
      }

      /* ---------- Matchmaking.html styles ---------- */
      #matchmaking {
        background: url(./Matchmake/MATCHMAKING_PAGE.png) center/cover fixed
          no-repeat;
        color: white;
        font-family: Panton, sans-serif;
        overflow: hidden;
        position: relative;
      }

      .centered-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 50px;
        text-align: center;
        white-space: nowrap;
        width: 100vw;
      }

      .t1 {
        font-size: 60px;
        margin: 0;
      }

      .t2,
      .t3 {
        font-size: 30px;
        margin: 0;
        white-space: normal;
      }
    </style>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- Cookie and JWT libs -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  </head>
  <body>
    <!-- Profile pic top-right -->
    <img id="profile-pic" alt="PFP" />

    <!-- === INDEX SECTION === -->
    <section id="index" class="active">
      <div>
        <img src="./Login/discord.png" class="dc" id="btn-discord" />
        <img src="./Login/join.png" class="join" />
        <img src="./Login/invite.png" class="invite" />
      </div>
    </section>

    <!-- === MENU SECTION === -->
    <section id="menu">
      <!-- MENU SCREEN -->
      <div class="menu-screen">
        <img src="./Menu/traditional.png" class="trad" id="btn-traditional" />
        <img src="./Menu/battle.png" class="battle" id="btn-battle" />
        <img src="./Menu/Line_121.png" class="menu-line" />
        <img src="./Menu/logo.png" class="menu-logo" />
      </div>

      <!-- SELECTION SCREEN -->
      <div class="selection-screen">
        <div class="fade-in-content">Welcome to the Selection Screen!</div>
        <img src="/Menu/pvp.png" class="pvb" />
        <img src="/Menu/pvb.png" class="pvp" />
        <img src="/Menu/select.png" class="pvbse" />
        <img src="/Menu/select.png" class="pvpse" />
      </div>

      <!-- RARITY SCREEN -->
      <div class="rarity-screen">
        <img src="Battle/PICK_A_RARITY.png" class="par" />
        <div class="rarity">
          <!-- Continuing rarity images -->
          <img src="Battle/rarity1.png" id="rarity1" />
          <img src="Battle/rarity2.png" id="rarity2" />
          <img src="Battle/rarity3.png" id="rarity3" />
          <img src="Battle/rarity4.png" id="rarity4" />
          <img src="Battle/rarity5.png" id="rarity5" />
        </div>
        <img src="Menu/Line_121.png" class="swipe-line" />
        <img src="Menu/logo.png" class="swipe-logo" />
      </div>
    </section>

    <!-- === PROFILE SECTION === -->
    <section id="profile">
      <img src="Profile/Rectangle_164.png" class="bg img-responsive" />
      <img src="Profile/Rectangle_166.png" class="bg2 img-responsive" />

      <div>
        <h1 class="theme">THEME</h1>
        <img
          src="Menu/bg.png"
          class="t1 img-responsive"
          onclick="setTheme('t1')" />
        <img
          src="Profile/MIDNIGHT_BLUE.png"
          class="t2 img-responsive"
          onclick="setTheme('t2')" />
        <img
          src="Profile/TUNDRA_MANGO.png"
          class="t3 img-responsive"
          onclick="setTheme('t3')" />
        <img
          src="Profile/RADIANT_ROCKET_LOLLY.png"
          class="t4 img-responsive"
          onclick="setTheme('t4')" />
        <img
          src="Profile/CHERRIES__CREAM.png"
          class="t5 img-responsive"
          onclick="setTheme('t5')" />
        <img
          src="Profile/SIREN_PURPLE.png"
          class="t6 img-responsive"
          onclick="setTheme('t6')" />

        <h1 class="t1t">SUMMER CYAN (DEFAULT)</h1>
        <h1 class="t2t">MIDNIGHT BLUE</h1>
        <h1 class="t3t">TUNDRA MANGO</h1>
        <h1 class="t4t">RADIANT ROCKET LOLLY</h1>
        <h1 class="t5t">CHERRIES & CREAM</h1>
        <h1 class="t6t">SIREN PURPLE</h1>
      </div>

      <img src="./Profile/C.png" class="levelb img-responsive" />
      <div class="pfp"></div>
      <h1 class="name">USERNAME</h1>
      <h1 class="level">LEVEL: 000</h1>
      <div class="pb">
        <div class="pb-fill"></div>
      </div>
      <h1 class="synthct">SYNTH CREDITS</h1>
      <img src="./Profile/SynthCredits.png" class="synthcl img-responsive" />
      <h1 class="synthc">00,000,000</h1>
      <h1 class="battlew">BATTLES WON:</h1>
      <h1 class="battlewn">00,000,000</h1>
      <h1 class="battlel">BATTLES LOST:</h1>
      <h1 class="battleln">00,000,000</h1>

      <button class="logout">Logout</button>
      <img
        src="./Assets/ICONS/back.png"
        class="back"
        onclick="navigateTo('menu')" />
    </section>

    <!-- === MATCHMAKING SECTION === -->
    <section id="matchmaking">
      <div class="centered-container">
        <h1 class="t1">Finding <span id="rarity-text"></span> Servers...</h1>
        <h1 class="t2">CONNECTING STATUS</h1>
        <h1 class="t3">00:00</h1>
      </div>
    </section>

    <!-- ===== SCRIPTS ===== -->
    <script>
      // Basic navigation function
      function navigateTo(sectionId) {
        document.querySelectorAll("section").forEach((sec) => {
          sec.classList.remove("active");
        });
        document.getElementById(sectionId).classList.add("active");
        updateProfilePicVisibility(sectionId);
      }

      // Show/hide profile pic on menu/profile pages only
      function updateProfilePicVisibility(sectionId) {
        const pfp = document.getElementById("profile-pic");
        if (sectionId === "menu" || sectionId === "profile") {
          pfp.style.display = "block";
        } else {
          pfp.style.display = "none";
        }
      }

      // --- Index Page Logic ---
      document.getElementById("btn-discord").addEventListener("click", () => {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Please login first!");
          return;
        }
        navigateTo("menu");
        loadProfilePic();
      });

      // --- Menu Page Logic ---
      // Menu buttons
      document
        .getElementById("btn-traditional")
        .addEventListener("click", () => {
          // For demonstration, let's just alert or do something
          alert("Traditional mode clicked (implement as needed)");
        });

      document.getElementById("btn-battle").addEventListener("click", () => {
        // Navigate to rarity screen (show rarity screen)
        showRarityScreen();
      });

      function showRarityScreen() {
        // Hide menu screen and selection screen, show rarity
        const menuSection = document.getElementById("menu");
        menuSection.querySelector(".menu-screen").style.display = "none";
        menuSection.querySelector(".selection-screen").style.display = "none";

        const rarityScreen = menuSection.querySelector(".rarity-screen");
        rarityScreen.classList.add("active");
      }

      // Handle rarity selection
      const rarityImages = document.querySelectorAll(
        "#menu .rarity-screen .rarity img"
      );
      rarityImages.forEach((img) => {
        img.addEventListener("click", () => {
          const selectedRarity = img.id.replace("rarity", "");
          localStorage.setItem("selectedRarity", selectedRarity);
          alert("Selected rarity: " + selectedRarity);

          // Go to matchmaking section
          navigateTo("matchmaking");

          // Start matchmaking with selected rarity
          startMatchmaking(selectedRarity);
        });
      });

      // --- Profile Page Logic ---
      function isTokenValid(token) {
        try {
          const decoded = jwt_decode(token);
          return decoded.exp * 1000 > Date.now();
        } catch {
          return false;
        }
      }

      function renderLoggedOut() {
        localStorage.removeItem("token");
        alert("Logged out.");
        navigateTo("index");
      }

      document
        .querySelector("#profile .logout")
        .addEventListener("click", () => {
          renderLoggedOut();
        });

      async function loadUserData() {
        try {
          const token = localStorage.getItem("token");
          if (!token || !isTokenValid(token)) {
            renderLoggedOut();
            return;
          }
          // Fetch user data (mock here or real fetch)
          const response = await fetch("/.netlify/functions/getUserData", {
            headers: {
              Authorization: "Bearer " + token,
            },
          });
          if (!response.ok) throw new Error("Failed to fetch user data");
          const data = await response.json();

          document.querySelector("#profile .name").textContent = data.username;
          document.querySelector(
            "#profile .level"
          ).textContent = `LEVEL: ${data.level.toString().padStart(3, "0")}`;
          document.querySelector("#profile .synthc").textContent =
            data.points.toLocaleString();
          document.querySelector("#profile .battlewn").textContent =
            data.battlesWon.toLocaleString();
          document.querySelector("#profile .battleln").textContent =
            data.battlesLost.toLocaleString();

          const neededXp = getXpForLevel(data.level);
          const progress = Math.min(data.xp / neededXp, 0.99);
          document.querySelector("#profile .pb-fill").style.width = `${
            progress * 100
          }%`;

          // Level badge
          const badge = document.querySelector("#profile .levelb");
          let src = "./Profile/C.png";
          if (data.level >= 1 && data.level <= 10) src = "./Profile/C.png";
          else if (data.level <= 40) src = "./Profile/E.png";
          else if (data.level <= 90) src = "./Profile/R.png";
          else if (data.level <= 110) src = "./Profile/L.png";
          else if (data.level < 200) src = "./Profile/U.png";
          else if (data.level === 200) src = "./Profile/I.png";
          badge.src = src;

          const pfpDiv = document.querySelector("#profile .pfp");
          pfpDiv.innerHTML = `<img src="${data.avatar}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;" />`;

          // Update profile picture top-right
          loadProfilePic(data.avatar);
        } catch (err) {
          console.error("Error loading user data:", err);
        }
      }

      function getXpForLevel(level) {
        return level * 50;
      }

      // Theme switching logic for profile
      const themes = {
        t1: {
          bg: "./Menu/bg.png",
          gradient: ["#40e0d0", "#29ff52"],
        },
        t2: {
          bg: "./Profile/MIDNIGHT_BLUE.png",
          gradient: ["#e393ff", "#1b11fc"],
        },
        t3: {
          bg: "./Profile/TUNDRA_MANGO.png",
          gradient: ["#f16300", "#09b313"],
        },
        t4: {
          bg: "./Profile/RADIANT_ROCKET_LOLLY.png",
          gradient: ["#d01ae6", "#ebf415"],
        },
        t5: {
          bg: "./Profile/CHERRIES__CREAM.png",
          gradient: ["#ff54c0", "#ffe1e4"],
        },
        t6: {
          bg: "./Profile/SIREN_PURPLE.png",
          gradient: ["#ec1927", "#0617af"],
        },
      };
      let lastChange = 0;

      function setTheme(key) {
        const now = Date.now();
        if (now - lastChange < 1000) return;
        lastChange = now;

        const profileSection = document.getElementById("profile");
        profileSection.style.background = `url(${themes[key].bg}) center/cover fixed no-repeat`;

        const [start, end] = themes[key].gradient;
        document.querySelector(
          "#profile .pb-fill"
        ).style.background = `linear-gradient(90deg, ${start} 0%, ${end} 100%)`;

        document
          .querySelectorAll(
            "#profile .t1, #profile .t2, #profile .t3, #profile .t4, #profile .t5, #profile .t6"
          )
          .forEach((el) => el.classList.remove("active-theme"));
        document
          .querySelector(`#profile .${key}`)
          .classList.add("active-theme");

        localStorage.setItem("selectedTheme", key);
      }

      // --- Load profile pic for menu and profile top-right ---
      function loadProfilePic(url) {
        const pfp = document.getElementById("profile-pic");
        if (!url) {
          // Try to get from user data
          const userDataAvatar = localStorage.getItem("userAvatar");
          if (userDataAvatar) url = userDataAvatar;
        }
        if (url) {
          pfp.src = url;
          pfp.style.display = "block";
        } else {
          pfp.style.display = "none";
        }
      }

      document.getElementById("profile-pic").addEventListener("click", () => {
        navigateTo("profile");
        loadUserData();
      });

      // --- Matchmaking Page Logic ---
      const rarityTextElem = document.getElementById("rarity-text");
      const t2 = document.querySelector("#matchmaking .t2");
      const t3 = document.querySelector("#matchmaking .t3");

      let secondsElapsed = 0;
      let ws;
      let timerInterval;

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60)
          .toString()
          .padStart(2, "0");
        const secs = (seconds % 60).toString().padStart(2, "0");
        return `${mins}:${secs}`;
      }

      function startTimer() {
        timerInterval = setInterval(() => {
          secondsElapsed++;
          t3.textContent = formatTime(secondsElapsed);
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
      }

      function connectWebSocket(rarity, token) {
        if (!token) {
          alert("No Token found. Please login.");
          navigateTo("index");
          return;
        }

        ws = new WebSocket(
          `wss://vdbe-0f2p.onrender.com/?token=${encodeURIComponent(token)}`
        );

        ws.onopen = () => {
          console.log("WebSocket connected");
          ws.send(JSON.stringify({ type: "join", rarity }));
          t2.textContent = "Finding match...";
          startTimer();
        };

        ws.onmessage = (event) => {
          let msg;
          try {
            msg = JSON.parse(event.data);
          } catch {
            console.log("Received non-JSON message:", event.data);
            return;
          }

          if (msg.type === "welcome") {
            console.log(msg.message); // ðŸ‘‹ Welcome user
          } else if (msg.type === "status") {
            t2.textContent = msg.message;
          } else if (msg.type === "match" || msg.type === "matched") {
            stopTimer();
            t3.textContent = "Successfully found match";
            t2.textContent = `âœ… Connected to ${
              msg.opponent || "Unknown Player"
            }`;

            console.log(`âœ… Connected to ${msg.opponent}`);
            console.log(
              `ðŸ§‘â€ðŸ’» You are: ${msg.yourName || "You"} (${msg.role || "Player"})`
            );

            // Save opponent and self info for battlep.html or wherever needed
            localStorage.setItem("matchedOpponent", msg.opponent || "Unknown");
            localStorage.setItem("yourName", msg.yourName || "You");
            localStorage.setItem("yourRole", msg.role || "Player");

            // Optionally show Player Two info on page here if needed
            // Then redirect to battle page after a short delay
            setTimeout(() => {
              alert("Redirecting to battle page (battlep.html)...");
              // window.location.href = "battlep.html"; // Uncomment to redirect
            }, 3000);
          }
        };

        ws.onclose = () => {
          console.log("WebSocket closed");
          if (!t3.textContent.includes("Successfully")) {
            t2.textContent = "Disconnected. Please refresh.";
            stopTimer();
          }
        };

        ws.onerror = (err) => {
          console.error("WebSocket error:", err);
          t2.textContent = "Connection error.";
          stopTimer();
        };
      }

      function startMatchmaking(rarity) {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("No token found. Please login.");
          navigateTo("index");
          return;
        }
        rarityTextElem.textContent = rarity;
        connectWebSocket(rarity, token);
      }

      // --- Initial load ---
      window.addEventListener("load", () => {
        // Check if logged in
        const token = localStorage.getItem("token");
        if (token && isTokenValid(token)) {
          // Show index page, show profile pic if logged in
          navigateTo("index");
          loadProfilePic();

          // Load saved theme for profile
          const savedTheme = localStorage.getItem("selectedTheme") || "t1";
          setTheme(savedTheme);
        } else {
          // Show index without profile pic
          navigateTo("index");
        }
      });
    </script>
  </body>
</html>
